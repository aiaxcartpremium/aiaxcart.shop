<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Aiaxcart Premium Shop</title>
<style>
  body{background:#fefaf7;color:#5a3e36;font-family:'Segoe UI',Tahoma,Verdana,sans-serif;margin:0}
  header{background:#FFD3D6;box-shadow:0 4px 15px rgba(0,0,0,.08)}
  .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .header-content{display:flex;justify-content:space-between;align-items:center;padding:1rem 0}
  nav ul{display:flex;gap:1rem;margin:0;padding:0;list-style:none}
  nav a{color:#5a3e36;text-decoration:none;padding:.5rem 1rem;border-radius:8px}
  nav a.active,nav a:hover{background:#FFC6CA}
  .user-info{display:none;align-items:center;gap:.7rem}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:#FFC6CA;display:grid;place-items:center;font-weight:700}
  .tabs{display:flex;gap:.4rem;background:#fff;border-radius:0 0 12px 12px;padding:.5rem;box-shadow:0 4px 15px rgba(0,0,0,.08);border-top:1px solid #F9E6E4;overflow-x:auto}
  .tab{padding:.6rem 1rem;border-radius:10px;white-space:nowrap;cursor:pointer}
  .tab.active{background:#FFD3D6}
  
  /* Products Grid */
  .products-grid{display:flex;flex-direction:column;gap:1rem;margin:1.2rem 0}
  .p-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  
  /* Category Sections */
  .category-section{margin:2rem 0}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
  .section-title{margin:0;color:#5a3e36;font-size:1.3rem}
  .view-all{color:#FFB0B5;text-decoration:none;font-weight:600}
  
  .btn{padding:.65rem 1rem;border:none;border-radius:10px;cursor:pointer}
  .btn-primary{background:#FFB0B5;color:#fff}
  .btn-primary:disabled{background:#ddd;color:#777}
  .card{background:#fff;border-radius:12px;padding:1.2rem;box-shadow:0 4px 15px rgba(0,0,0,.08);margin:1rem 0}
  .search-wrap{margin:1rem 0;position:relative}
  .search-wrap input{width:100%;padding:.8rem 1rem .8rem 2.4rem;border:1px solid #F9E6E4;border-radius:10px}
  .search-wrap span{position:absolute;left:.8rem;top:50%;transform:translateY(-50%)}
  .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#fff3cd;color:#856404;font-size:.8rem;font-weight:700}
  footer{background:#5a3e36;color:#fff;text-align:center;padding:1.2rem 0;margin-top:2rem}
  #toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:99999}
  .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);opacity:.98}
  .toast.ok{background:#28a745}
  .toast.warn{background:#ff9800}
  .toast.err{background:#e74c3c}
  .note{font-size:.85rem;opacity:.8}
  h2.section-title{margin-top:2rem;margin-bottom:.5rem}
  
  /* Category Tabs */
  .category-tabs{display:flex;gap:.5rem;margin:1.5rem 0;overflow-x:auto;padding-bottom:.5rem}
  .category-tab{padding:.6rem 1.2rem;border-radius:999px;background:#fff;border:1px solid #F9E6E4;cursor:pointer;white-space:nowrap;transition:all .3s ease}
  .category-tab.active{background:#FFD3D6;color:#5a3e36;border-color:#FFD3D6}
</style>
</head>
<body>
<div id="toast"></div>
<header>
  <div class="container header-content">
    <div class="logo">üõí Aiaxcart Premium</div>
    <nav>
      <ul>
        <li><a class="active" href="index.html">Home</a></li>
        <li><a id="admin-btn" href="admin.html">Admin</a></li>
      </ul>
    </nav>
    <div id="auth-buttons">
      <button class="btn" id="login-btn">Login / Sign up</button>
    </div>
    <div id="user-info" class="user-info">
      <div id="user-avatar" class="user-avatar"></div>
      <span id="user-name"></span>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </div>
  <div class="container tabs">
    <div class="tab active" data-tab="products">Products</div>
    <div class="tab" data-tab="accounts">My Account</div>
    <div class="tab" data-tab="reports">Report Issue</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="rules">Rules</div>
    <div class="tab" data-tab="feedback">Feedback</div>
    <div class="tab" data-tab="about">About</div>
  </div>
</header>

<main class="container">
  <div class="search-wrap">
    <span>üîç</span>
    <input id="product-search" placeholder="Search products‚Ä¶"/>
  </div>

  <!-- Category Tabs -->
  <div class="category-tabs" id="category-tabs">
    <div class="category-tab active" data-category="all">All Categories</div>
    <div class="category-tab" data-category="entertainment">üé¨ Entertainment</div>
    <div class="category-tab" data-category="streaming">üéß Streaming</div>
    <div class="category-tab" data-category="educational">üìö Educational</div>
    <div class="category-tab" data-category="editing">üé® Editing</div>
    <div class="category-tab" data-category="ai">ü§ñ AI</div>
  </div>

  <section id="products-section" style="margin-top:1.5rem">
    <div id="categories-container">
      <div class="note">Loading products...</div>
    </div>
  </section>

  <!-- Other sections -->
  <section id="accounts-content" class="card" style="display:none">
    <div class="note">Please login to view your account.</div>
  </section>

  <section id="reports-content" class="card" style="display:none">
    <h3>Report an Issue</h3>
    <div id="report-gate" class="note">Please login to report an issue.</div>
    <div id="report-form" style="display:none">
      <div class="row"><label>Order (optional)</label><input id="rep-order"></div>
      <div class="row"><label>Product</label><input id="rep-product"></div>
      <div class="row"><label>Issue</label><textarea id="rep-issue" rows="3"></textarea></div>
      <div class="row"><label>Attach image</label><input id="rep-img" type="file" accept="image/*"></div>
      <button class="btn btn-primary" id="rep-submit">Submit Report</button>
    </div>
  </section>

  <section id="payments-content" class="card" style="display:none">
    <h3>Payment Methods</h3>
    <p>GCash: <b>0962 554 4105</b></p>
    <p>Maya: <b>0929 984 3629</b></p>
  </section>

  <section id="rules-content" class="card" style="display:none">
    <h3>Store Rules</h3>
    <div id="rules-wrap" class="note">Loading rules...</div>
  </section>

  <section id="feedback-content" class="card" style="display:none">
    <h3>Customer Feedback</h3>
    <div id="fb-list" class="note">Loading feedback...</div>
  </section>

  <section id="about-content" class="card" style="display:none">
    <p>Aiaxcart Premium ‚Äî Your trusted source for premium digital accounts.</p>
  </section>
</main>

<footer>
  <div class="container">¬© 2024 Aiaxcart Premium. All rights reserved.</div>
</footer>

<!-- Checkout Modal -->
<div id="coOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem">
    <h3 id="coTitle">Checkout</h3>
    <form id="coForm" onsubmit="return false;">
      <input type="hidden" name="product_id"/>
      <input type="hidden" name="product_name"/>
      <div style="margin-bottom:1rem"><label>Buyer Name</label><input required name="buyer_name" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="margin-bottom:1rem"><label>Email</label><input required type="email" name="buyer_email" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="margin-bottom:1rem"><label>Account Type</label>
        <select name="account_type" required style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px">
          <option>Solo Profile</option>
          <option>Shared Profile</option>
          <option>Solo Account</option>
          <option>Shared Account</option>
          <option>invite</option>
          <option>famhead</option>
        </select>
      </div>
      <div style="margin-bottom:1rem"><label>Duration</label>
        <select name="duration_key" required style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px">
          <option>7d</option><option>14d</option><option>1m</option><option>2m</option>
          <option>3m</option><option>4m</option><option>6m</option><option>8m</option>
          <option>10m</option><option>12m</option>
        </select>
      </div>
      <div style="margin-bottom:1rem"><label>Price (‚Ç±)</label><input type="number" step="0.01" required name="price" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="display:flex;gap:.6rem;margin-top:.9rem">
        <button type="button" class="btn" onclick="closeCheckout()">Cancel</button>
        <button id="coSubmit" type="submit" class="btn btn-primary">Place Order</button>
      </div>
    </form>
    <div id="coMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem">
    <div style="display:flex;gap:.4rem;margin-bottom:.6rem">
      <button id="tabLogin" class="btn">Login</button>
      <button id="tabSignup" class="btn btn-primary">Sign up</button>
      <button style="margin-left:auto" class="btn" onclick="closeAuth()">√ó</button>
    </div>
    <div id="formLogin">
      <div style="margin-bottom:1rem"><label>Email</label><input id="liEmail" type="email" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="margin-bottom:1rem"><label>Password</label><input id="liPass" type="password" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <button class="btn btn-primary" id="btnLoginGo">Login</button>
    </div>
    <div id="formSignup" style="display:none">
      <div style="margin-bottom:1rem"><label>Full name</label><input id="suName" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="margin-bottom:1rem"><label>Email</label><input id="suEmail" type="email" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="margin-bottom:1rem"><label>Password</label><input id="suPass" type="password" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <div style="margin-bottom:1rem"><label>Confirm</label><input id="suPass2" type="password" style="width:100%;padding:.5rem;border:1px solid #F9E6E4;border-radius:8px"></div>
      <button class="btn btn-primary" id="btnSignupGo">Create account</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- CONFIG -->
<script>
window.CONFIG_PUBLIC = {
  DATABASE:{
    SUPABASE_URL:"https://oujvsjnbxmgpdoftzpxl.supabase.co",
    SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91anZzam5ieG1ncGRvZnR6cHhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzE1NTYsImV4cCI6MjA3ODQ0NzU1Nn0.vs06C-2kx4H2whyTReUPsVgLYhWotfkzetxdKD5LVQo"
  },
  ADMIN:{ OWNER_UID:"2ece6eb8-ed7d-4e52-b1b8-f9220fb87e36" }
};
</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/js/aiaxcart/supabase.js?v=6"></script>

<script>
const SB = createDbClient();
const $ = (id)=>document.getElementById(id);

// Simple demo catalog for testing
window.AIAX_CATALOG = [
  {
    id: 'netflix-premium',
    name: 'Netflix Premium',
    category: 'entertainment',
    icon: 'üé¨',
    pricing: {
      'Solo Account': {'1m': 149, '3m': 399},
      'Shared Account': {'1m': 99, '3m': 269}
    }
  },
  {
    id: 'spotify-premium',
    name: 'Spotify Premium',
    category: 'streaming',
    icon: 'üéß',
    pricing: {
      'Individual': {'1m': 99, '3m': 269},
      'Family': {'1m': 149, '3m': 399}
    }
  },
  {
    id: 'youtube-premium',
    name: 'YouTube Premium',
    category: 'streaming',
    icon: 'üì∫',
    pricing: {
      'Individual': {'1m': 199, '3m': 549},
      'Family': {'1m': 299, '3m': 799}
    }
  },
  {
    id: 'canva-pro',
    name: 'Canva Pro',
    category: 'editing',
    icon: 'üé®',
    pricing: {
      'Team Account': {'1m': 199, '3m': 549}
    }
  }
];

/* ===== toast ===== */
function toast(msg, type='ok'){
  const box=$('toast');
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  box.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),300); },1800);
}

/* ===== auth local ===== */
let currentUser = getSavedUser();
function getSavedUser(){
  const s=localStorage.getItem('aiaxcart_current_user');
  return s?JSON.parse(s):null;
}
function saveUser(u){
  currentUser=u;
  if(u) localStorage.setItem('aiaxcart_current_user',JSON.stringify(u));
  else localStorage.removeItem('aiaxcart_current_user');
}
function openAuth(){ $('authOverlay').style.display='flex'; }
function closeAuth(){ $('authOverlay').style.display='none'; $('authMsg').textContent=''; }

function refreshAuthUI(){
  const ab=$('auth-buttons');
  const ui=$('user-info');
  if(currentUser){
    ab.style.display='none';
    ui.style.display='flex';
    $('user-name').textContent=currentUser.name;
    $('user-avatar').textContent=currentUser.name.charAt(0).toUpperCase();
  }else{
    ab.style.display='block';
    ui.style.display='none';
  }
}
$('login-btn').onclick=openAuth;
$('logout-btn').onclick=()=>{ saveUser(null); refreshAuthUI(); toast('Logged out','ok'); };

/* tabs */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('main .card').forEach(c=>c.style.display='none');
    $('products-section').style.display='block';
    tab.classList.add('active');
    const key=tab.dataset.tab;
    if(key!=='products'){
      $('products-section').style.display='none';
      $(key+'-content').style.display='block';
      if(key==='rules') loadRules();
    }
  });
});

/* auth flows */
$('tabLogin').onclick=()=>{ $('formLogin').style.display='block'; $('formSignup').style.display='none'; };
$('tabSignup').onclick=()=>{ $('formLogin').style.display='none'; $('formSignup').style.display='block'; };

$('btnSignupGo').onclick=async()=>{
  const n=$('suName').value.trim(),
        e=$('suEmail').value.trim(),
        p=$('suPass').value,
        p2=$('suPass2').value;
  if(!n||!e||!p||p!==p2){ $('authMsg').textContent='Check inputs.'; return; }
  let arr=JSON.parse(localStorage.getItem('aiaxcart_users')||'[]');
  if(arr.some(x=>x.email===e)){ $('authMsg').textContent='Email exists.'; return; }
  const u={id:Date.now(),name:n,email:e,password:p,joinDate:new Date().toISOString()};
  arr.push(u);
  localStorage.setItem('aiaxcart_users',JSON.stringify(arr));
  await db_upsertBuyer(u);
  saveUser(u);
  refreshAuthUI();
  closeAuth();
  toast('Account created','ok');
};
$('btnLoginGo').onclick=async()=>{
  const e=$('liEmail').value.trim(),
        p=$('liPass').value;
  const arr=JSON.parse(localStorage.getItem('aiaxcart_users')||'[]');
  const u=arr.find(x=>x.email===e && x.password===p);
  if(!u){ $('authMsg').textContent='Invalid credentials.'; return; }
  await db_upsertBuyer(u);
  saveUser(u);
  refreshAuthUI();
  closeAuth();
  toast('Welcome back','ok');
};

/* Category Tabs */
document.querySelectorAll('.category-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    filterProductsByCategory(this.dataset.category);
  });
});

function filterProductsByCategory(category) {
  const products = document.querySelectorAll('.p-card');
  const sections = document.querySelectorAll('.category-section');
  
  if (category === 'all') {
    sections.forEach(section => section.style.display = 'block');
    products.forEach(product => product.style.display = 'block');
  } else {
    sections.forEach(section => {
      section.style.display = section.dataset.category === category ? 'block' : 'none';
    });
  }
}

/* Products */
async function renderProducts(){
  const container=$('categories-container');
  
  try {
    // Try to seed with demo catalog first
    try {
      await db_seedCatalogIfEmpty(window.AIAX_CATALOG);
    } catch(e) {
      console.log('Seeding may have failed:', e);
    }
    
    const rows = await db_listCatalogWithCounts();
    
    if(!rows.length){
      // Show demo products if no real products
      showDemoProducts();
      return;
    }

    const byCat = {};
    rows.forEach(p => {
      const cat = p.category || 'others';
      (byCat[cat] = byCat[cat] || []).push(p);
    });

    const catOrder = ['entertainment', 'streaming', 'educational', 'editing', 'ai'];
    let html = '';
    
    catOrder.forEach(cat => {
      const items = byCat[cat];
      if(!items || !items.length) return;
      
      const catNames = {
        entertainment: 'üé¨ Entertainment',
        streaming: 'üéß Streaming & Music', 
        educational: 'üìö Educational',
        editing: 'üé® Editing & Creative',
        ai: 'ü§ñ AI Tools'
      };
      
      // Show only first 3 products
      const displayItems = items.slice(0, 3);
      const hasMore = items.length > 3;
      
      html += `
        <div class="category-section" data-category="${cat}">
          <div class="section-header">
            <h2 class="section-title">${catNames[cat] || cat}</h2>
            ${hasMore ? `<a href="#" class="view-all" onclick="showAllCategory('${cat}')">View All</a>` : ''}
          </div>
          <div class="products-grid">
            ${displayItems.map(p => {
              const hasStock = (p.available || 0) > 0;
              const prices = p.prices || [];
              const priceDisplay = prices.length ? 
                `From ‚Ç±${Math.min(...prices.map(x => x.price_php))}` : 
                'Price not set';
                
              return `
                <div class="p-card" data-name="${(p.name||'').toLowerCase()}">
                  <div style="font-weight:700;font-size:1.05rem">${p.icon||'üõí'} ${p.name}</div>
                  <div>${hasStock 
                    ? `<span class="pill" style="background:#d4edda;color:#155724">${p.available} available</span>`
                    : `<span class="pill">Out of stock</span>`}</div>
                  <div class="note">${priceDisplay}</div>
                  <button class="btn btn-primary" ${hasStock?'':'disabled'}
                    onclick="openCheckout('${p.id}','${p.name.replace(/'/g, "\\'")}')">
                    ${hasStock?'Buy Now':'Unavailable'}
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html || '<div class="note">No products available.</div>';
    
  } catch(e) {
    console.error('Error loading products:', e);
    showDemoProducts();
  }
}

function showDemoProducts() {
  const container = $('#categories-container');
  container.innerHTML = `
    <div class="category-section" data-category="entertainment">
      <div class="section-header">
        <h2 class="section-title">üé¨ Entertainment</h2>
      </div>
      <div class="products-grid">
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üé¨ Netflix Premium</div>
          <div><span class="pill" style="background:#d4edda;color:#155724">5 available</span></div>
          <div class="note">From ‚Ç±149</div>
          <button class="btn btn-primary" onclick="openCheckout('netflix','Netflix Premium')">Buy Now</button>
        </div>
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üì∫ Disney+</div>
          <div><span class="pill">Out of stock</span></div>
          <div class="note">From ‚Ç±129</div>
          <button class="btn btn-primary" disabled>Unavailable</button>
        </div>
      </div>
    </div>
    <div class="category-section" data-category="streaming">
      <div class="section-header">
        <h2 class="section-title">üéß Streaming & Music</h2>
      </div>
      <div class="products-grid">
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üéß Spotify Premium</div>
          <div><span class="pill" style="background:#d4edda;color:#155724">3 available</span></div>
          <div class="note">From ‚Ç±99</div>
          <button class="btn btn-primary" onclick="openCheckout('spotify','Spotify Premium')">Buy Now</button>
        </div>
      </div>
    </div>
  `;
}

function showAllCategory(category) {
  // For now, just show a message
  toast(`Showing all ${category} products`, 'ok');
  filterProductsByCategory(category);
}

function openCheckout(product_id, product_name){
  const f=$('coForm');
  f.product_id.value=product_id;
  f.product_name.value=product_name;
  $('coTitle').textContent='Checkout ‚Ä¢ '+product_name;
  if(currentUser){
    f.buyer_name.value=currentUser.name;
    f.buyer_email.value=currentUser.email;
  }
  $('coOverlay').style.display='flex';
}

function closeCheckout(){ $('coOverlay').style.display='none'; }

$('coForm').addEventListener('submit',async(e)=>{
  e.preventDefault();
  const f=e.target;
  const btn=$('coSubmit');
  btn.disabled=true;
  try{
    const order=await db_createOrder({
      buyer_name:f.buyer_name.value.trim(),
      buyer_email:f.buyer_email.value.trim(),
      product_id:f.product_id.value,
      product_name:f.product_name.value,
      account_type:f.account_type.value,
      duration_key:f.duration_key.value,
      price:parseFloat(f.price.value||0)
    });
    $('coMsg').textContent='‚úÖ Order placed! ID: '+order.id;
    toast('Order placed','ok');
    setTimeout(()=>{ $('coMsg').textContent=''; closeCheckout(); },2000);
  }catch(err){
    alert('Checkout failed: '+err.message);
  }finally{
    btn.disabled=false;
  }
});

/* rules */
async function loadRules(){
  try{
    const rules=await db_fetchRules();
    $('rules-wrap').innerHTML = rules.length ? 
      rules.map(r=>`<div style="margin:.5rem 0">‚Ä¢ ${r.text}</div>`).join('') :
      '<div>No rules set yet.</div>';
  }catch(_){
    $('rules-wrap').innerHTML='<div>Failed to load rules.</div>';
  }
}

/* search */
$('product-search').addEventListener('input',(e)=>{
  const q=e.target.value.toLowerCase();
  document.querySelectorAll('.p-card').forEach(card=>{
    const name=card.dataset.name||'';
    card.style.display=name.includes(q)?'block':'none';
  });
});

/* init */
document.addEventListener('DOMContentLoaded',()=>{
  refreshAuthUI();
  renderProducts();
  loadRules();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Aiaxcart Premium Shop</title>
<link rel="stylesheet" href="assets/css/extras.css"/>
<style>
  body{background:#fefaf7;color:#5a3e36;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
  header{background:#FFD3D6;box-shadow:0 4px 15px rgba(0,0,0,.08)}
  .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .header-content{display:flex;justify-content:space-between;align-items:center;padding:1rem 0}
  nav ul{display:flex;list-style:none;gap:1rem}
  nav a{color:#5a3e36;text-decoration:none;padding:.5rem 1rem;border-radius:8px}
  nav a.active,nav a:hover{background:#FFC6CA}
  .user-info{display:none;align-items:center;gap:.7rem}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:#FFC6CA;display:grid;place-items:center;font-weight:700}
  .tabs{display:flex;gap:.4rem;background:#fff;border-radius:0 0 12px 12px;padding:.5rem;box-shadow:0 4px 15px rgba(0,0,0,.08);border-top:1px solid #F9E6E4;overflow-x:auto}
  .tab{padding:.6rem 1rem;border-radius:10px;white-space:nowrap;cursor:pointer}
  .tab.active{background:#FFD3D6}
  .products-grid{display:flex;flex-direction:column;gap:2rem;margin:1.5rem 0}
  .products-category-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
  .p-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .p-title{font-weight:700}
  .p-stock{margin:.25rem 0}
  .btn{padding:.65rem 1rem;border:none;border-radius:10px;cursor:pointer}
  .btn-primary{background:#FFB0B5;color:#fff}
  .btn-primary:disabled{background:#ddd;color:#777;cursor:not-allowed}
  .card{background:#fff;border-radius:12px;padding:1.2rem;box-shadow:0 4px 15px rgba(0,0,0,.08);margin:1rem 0}
  .search-wrap{margin:1rem 0;position:relative}
  .search-wrap input{width:100%;padding:.8rem 1rem .8rem 2.4rem;border:1px solid #F9E6E4;border-radius:10px}
  .search-wrap span{position:absolute;left:.8rem;top:50%;transform:translateY(-50%)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem}
  .row{margin:.6rem 0}
  .row label{display:block;margin:.25rem 0;font-weight:600}
  .row input,.row select,.row textarea{width:100%;padding:.6rem;border:1px solid #F9E6E4;border-radius:10px}
  .note{font-size:.9rem;opacity:.8}
  .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#fff3cd;color:#856404;font-size:.8rem;font-weight:700}
  footer{background:#5a3e36;color:#fff;text-align:center;padding:1.2rem 0;margin-top:2rem}
  @media(max-width:768px){nav ul{flex-wrap:wrap}}
</style>
</head>
<body>

<header>
  <div class="container header-content">
    <div class="logo">üõí Aiaxcart Premium</div>
    <nav>
      <ul>
        <li><a class="active" href="index.html">Home</a></li>
        <li><a id="admin-btn" href="admin.html">Admin</a></li>
      </ul>
    </nav>
    <div id="auth-buttons"><button class="btn" id="login-btn">Login / Sign up</button></div>
    <div id="user-info" class="user-info">
      <div id="user-avatar" class="user-avatar"></div>
      <span id="user-name"></span>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </div>

  <div class="container tabs">
    <div class="tab active" data-tab="products">Products</div>
    <div class="tab" data-tab="accounts">My Account</div>
    <div class="tab" data-tab="reports">Report Issue</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="rules">Rules</div>
    <div class="tab" data-tab="feedback">Feedback</div>
    <div class="tab" data-tab="about">About</div>
  </div>
</header>

<main class="container">
  <div class="search-wrap"><span>üîç</span><input id="product-search" placeholder="Search products‚Ä¶"/></div>

  <!-- Products Section -->
  <section style="margin-top:1.5rem;">
    <h2>Products</h2>
    <div id="products-wrap" class="products-grid"></div>
  </section>

  <!-- Other tabs -->
  <section id="accounts-content" class="card" style="display:none"></section>

  <section id="reports-content" class="card" style="display:none">
    <h3>Report an Issue</h3>
    <div id="report-gate" class="note">Please login to report an issue.</div>
    <div id="report-form" style="display:none">
      <div class="row"><label>Order ID (optional)</label><input id="rep-order"/></div>
      <div class="row"><label>Product</label><input id="rep-product"/></div>
      <div class="row"><label>Issue</label><textarea id="rep-issue" rows="3"></textarea></div>
      <button class="btn btn-primary" id="rep-submit">Submit Report</button>
    </div>
    <div id="my-reports" style="margin-top:1rem"></div>
  </section>

  <section id="payments-content" class="card" style="display:none">
    <h3>Payment Methods</h3>
    <p>GCash: <b>0962 554 4105</b></p><p>Maya: <b>0929 984 3629</b></p>
  </section>

  <section id="rules-content" class="card" style="display:none">
    <h3>Store Rules</h3>
    <div class="row"><input id="rules-search" placeholder="Search rules‚Ä¶"></div>
    <div id="rules-wrap"></div>
  </section>

  <section id="feedback-content" class="card" style="display:none">
    <h3>Customer Feedback</h3>
    <div id="fb-gate" class="note">Please login to leave feedback.</div>
    <div id="fb-form" style="display:none">
      <div class="row"><label>Your feedback</label><textarea id="fb-text" rows="3"></textarea></div>
      <button class="btn btn-primary" id="fb-submit">Submit</button>
    </div>
    <div id="fb-list" style="margin-top:1rem"></div>
  </section>

  <section id="about-content" class="card" style="display:none">
    <p>Aiaxcart Premium ‚Äî Your trusted source for premium digital accounts.</p>
  </section>
</main>

<footer><div class="container">¬© 2024 Aiaxcart Premium. All rights reserved.</div></footer>

<!-- CHECKOUT MODAL -->
<div id="coOverlay" class="overlay">
  <div class="modal">
    <h3 id="coTitle">Checkout</h3>
    <form id="coForm" onsubmit="return false;">
      <input type="hidden" name="product_id"/>
      <input type="hidden" name="product_name"/>
      <div class="row"><label>Buyer Name</label><input required name="buyer_name"></div>
      <div class="row"><label>Email</label><input required type="email" name="buyer_email"></div>
      <div class="row">
        <label>Account Type</label>
        <select name="account_type" required id="co_accType">
          <option>Solo Profile</option><option>Shared Profile</option>
          <option>Solo Account</option><option>Shared Account</option>
          <option>invite</option><option>famhead</option>
        </select>
      </div>
      <div class="row" id="inviteGmailRow" style="display:none">
        <label>Gmail for Invite (required for invite)</label>
        <input type="email" name="invite_gmail" placeholder="yourgmail@gmail.com">
        <small class="note">Must be a Gmail address (separate from login email).</small>
      </div>
      <div class="row">
        <label>Duration</label>
        <select name="duration_key" required>
          <option>7d</option><option>14d</option><option>1m</option><option>2m</option>
          <option>3m</option><option>4m</option><option>6m</option><option>8m</option>
          <option>10m</option><option>12m</option>
        </select>
      </div>
      <div class="row"><label>Price (‚Ç±)</label><input type="number" step="0.01" required name="price"></div>
      <div style="display:flex;gap:.6rem;margin-top:.9rem;">
        <button type="button" class="btn" onclick="closeCheckout()">Cancel</button>
        <button id="coSubmit" type="submit" class="btn btn-primary">Place Order</button>
      </div>
    </form>
    <div id="coMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- AUTH MODAL (simple) -->
<div id="authOverlay" class="overlay">
  <div class="modal">
    <div style="display:flex;gap:.4rem;margin-bottom:.6rem">
      <button id="tabLogin"  class="btn"        >Login</button>
      <button id="tabSignup" class="btn btn-primary">Sign up</button>
      <button style="margin-left:auto" class="btn" onclick="closeAuth()">√ó</button>
    </div>
    <div id="formLogin">
      <div class="row"><label>Email</label><input id="liEmail" type="email"></div>
      <div class="row"><label>Password</label><input id="liPass" type="password"></div>
      <button class="btn btn-primary" id="btnLoginGo">Login</button>
    </div>
    <div id="formSignup" style="display:none">
      <div class="row"><label>Full name</label><input id="suName"></div>
      <div class="row"><label>Email</label><input id="suEmail" type="email"></div>
      <div class="row"><label>Password</label><input id="suPass" type="password"></div>
      <div class="row"><label>Confirm</label><input id="suPass2" type="password"></div>
      <button class="btn btn-primary" id="btnSignupGo">Create account</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- ===== CONFIG (inline fallback; also reads config.private.js/config.js if present) ===== -->
<script>
  window.CONFIG_PRIVATE = window.CONFIG_PRIVATE || undefined;
  window.CONFIG_PUBLIC  = window.CONFIG_PUBLIC  || {
    DATABASE:{ SUPABASE_URL:"YOUR_SUPABASE_URL_HERE", SUPABASE_ANON_KEY:"YOUR_SUPABASE_ANON_KEY_HERE" },
    ADMIN:{ OWNER_UID:"2ece6eb8-ed7d-4e52-b1b8-f9220fb87e36" }
  };
  window.CONFIG = window.CONFIG_PRIVATE || window.CONFIG_PUBLIC;
</script>
<script src="config.private.js"></script>
<script src="config.js"></script>
<script> window.CONFIG = window.CONFIG_PRIVATE || window.CONFIG_PUBLIC || window.CONFIG; </script>

<!-- Supabase + helpers -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/js/aiaxcart/supabase.js?v=4"></script>

<script>
/* ===== BOOT ===== */
const SB = createDbClient();                // from supabase.js (hybrid helpers)
let currentUser = getSavedUser();

document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name=t.dataset.tab;
    document.querySelectorAll('main section.card').forEach(s=>s.style.display='none');
    document.getElementById('products-wrap').parentElement.style.display=(name==='products')?'block':'none';
    ['accounts','reports','payments','rules','feedback','about'].forEach(n=>{
      const el=document.getElementById(`${n}-content`);
      if(el) el.style.display=(name===n)?'block':'none';
    });
    if(name==='accounts') renderAccountTab();
    if(name==='rules')    renderRules();
  };
});

document.getElementById('login-btn').onclick=openAuth;
document.getElementById('logout-btn').onclick=()=>{saveUser(null);refreshAuthUI();};
document.getElementById('product-search').addEventListener('input', e=>{
  const q = e.target.value.trim().toLowerCase();
  document.querySelectorAll('.p-card').forEach(card=>{
    const name = card.getAttribute('data-name')||'';
    card.style.display = name.includes(q)?'block':'none';
  });
});
document.getElementById('co_accType').addEventListener('change', e=>{
  document.getElementById('inviteGmailRow').style.display = (e.target.value.toLowerCase()==='invite')?'block':'none';
});

/* ===== PRODUCTS (DB-first; local fallback) ===== */
async function renderProducts(){
  const wrap = document.getElementById('products-wrap');
  wrap.innerHTML = 'Loading‚Ä¶';
  try{
    const prods = await db_listProductsWithStock(); // [{product_id,name,icon,category,stock_count,sold_count}]
    const grouped = groupBy(prods, 'category');
    wrap.innerHTML = Object.entries(grouped).map(([cat,arr])=>{
      return `
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin:.2rem 0 .6rem">
            <h3>${prettyCat(cat)}</h3>
            <span class="note">${arr.length} items</span>
          </div>
          <div class="products-category-grid">
            ${arr.map(p=>pCard(p)).join('')}
          </div>
        </div>`;
    }).join('');
  }catch(e){
    const local = JSON.parse(localStorage.getItem('products')||'[]');
    wrap.innerHTML = (local.length? local.map(p=>pCard({
      product_id:p.id,name:p.name,icon:p.icon,category:p.category,stock_count:p.stock||0,sold_count:p.sold||0
    })).join(''): '<div class="note">No products.</div>');
  }
}
function pCard(p){
  const oos = (p.stock_count||0)<=0;
  return `
  <div class="p-card" data-name="${(p.name||'').toLowerCase()}">
    <div class="p-title">${p.icon||'üõí'} ${p.name}</div>
    <div class="note">${p.category||''}</div>
    <div class="p-stock" style="${oos?'color:#b22':''}">
      ${oos? 'Out of stock' : `In stock: ${p.stock_count}`} &nbsp;<span class="pill">${p.sold_count||0} sold</span>
    </div>
    <button class="btn btn-primary" ${oos?'disabled':''}
      onclick="openCheckout('${p.product_id}','${encodeURIComponent(p.name)}')">${oos?'Unavailable':'Buy'}</button>
  </div>`;
}
function prettyCat(c){const map={entertainment:'üé¨ Entertainment',streaming:'üéµ Music & Streaming',educational:'üìö Educational',editing:'üé® Editing Tools',ai:'ü§ñ AI Tools'};return map[c]||c;}
function groupBy(arr,k){return arr.reduce((a,x)=>((a[x[k]]=a[x[k]]||[]).push(x),a),{});}

/* ===== CHECKOUT ===== */
function openCheckout(product_id, product_name){
  const f = document.getElementById('coForm');
  f.product_id.value = product_id;
  f.product_name.value = decodeURIComponent(product_name);
  document.getElementById('coTitle').innerText = `Checkout ‚Ä¢ ${decodeURIComponent(product_name)}`;
  document.getElementById('coMsg').innerText='';
  if(currentUser){ f.buyer_name.value=currentUser.name||''; f.buyer_email.value=currentUser.email||''; }
  document.getElementById('coOverlay').style.display='flex';
}
function closeCheckout(){ document.getElementById('coOverlay').style.display='none'; }
document.getElementById('coForm').addEventListener('submit', async (e)=>{
  const btn = document.getElementById('coSubmit'); btn.disabled=true;
  const f = e.target;
  try{
    if (f.account_type.value.toLowerCase()==='invite'){
      const gm = (f.invite_gmail.value||'').trim().toLowerCase();
      if(!gm.endsWith('@gmail.com')) throw new Error('Invite requires a Gmail address.');
    }
    const payload = {
      buyer_name:  f.buyer_name.value.trim(),
      buyer_email: f.buyer_email.value.trim(),
      product_id:  f.product_id.value,
      product_name:f.product_name.value,
      account_type:f.account_type.value,
      duration_key:f.duration_key.value,
      price:       Number(f.price.value||0),
      invite_gmail:(f.invite_gmail?.value||null)
    };
    const order = await db_createOrder(payload); // writes to DB, adjusts counters
    document.getElementById('coMsg').innerText = '‚úÖ Order placed. ID: '+order.id;
    setTimeout(()=>{ closeCheckout(); f.reset(); }, 800);
  }catch(err){
    alert('Checkout failed: '+(err.message||err));
  }finally{ btn.disabled=false; }
});

/* ===== RULES / FEEDBACK / ACCOUNT ===== */
async function renderRules(){
  const box = document.getElementById('rules-wrap');
  try{
    const rows = await db_listRules();
    const by = groupBy(rows,'product');
    box.innerHTML = Object.keys(by).sort().map(prod=>{
      const title = prod==='general'?'General Rules & Regulations':`${prod} Rules`;
      return `<div class="card"><h4>${title}</h4>${by[prod].map(r=>`<div class="note">‚Ä¢ ${r.text}</div>`).join('')}</div>`;
    }).join('');
  }catch(e){
    const rules = JSON.parse(localStorage.getItem('rules')||'[]');
    const by = groupBy(rules,'product');
    box.innerHTML = Object.keys(by).map(prod=>{
      const title = prod==='general'?'General Rules & Regulations':`${prod} Rules`;
      return `<div class="card"><h4>${title}</h4>${by[prod].map(r=>`<div class="note">‚Ä¢ ${r.text}</div>`).join('')}</div>`;
    }).join('') || '<div class="note">No rules.</div>';
  }
}
function renderAccountTab(){
  const box = document.getElementById('accounts-content');
  if(!currentUser){ box.innerHTML = `<h3>My Account</h3><div class="note">Login to view your orders.</div>`; return; }
  const orders = JSON.parse(localStorage.getItem('aiaxcart_orders')||'[]').filter(o=>o.user?.email===currentUser.email);
  box.innerHTML = `
    <h3>My Account</h3>
    <div class="card"><b>Name:</b> ${currentUser.name}<br><b>Email:</b> ${currentUser.email}</div>
    <div class="card"><h4>Order History</h4>
      ${orders.length? orders.map(o=>`
        <div style="border:1px solid #F9E6E4;border-radius:10px;padding:.6rem;margin:.4rem 0">
          <div><b>${o.product?.productName||o.product_name}</b> ‚Ä¢ ‚Ç±${o.product?.price||o.price||0}</div>
          <div class="note">${o.product?.accountType||o.account_type} ‚Ä¢ ${o.product?.duration||o.duration_key}</div>
          <div class="pill">${o.processed?'Completed':'Pending'}</div>
        </div>`).join('') : '<div class="note">No orders yet.</div>'}
    </div>`;
}

/* reports/feedback */
document.getElementById('rep-submit').onclick=async()=>{
  if(!currentUser) return alert('Login first.');
  const data = {
    orderId:document.getElementById('rep-order').value,
    product:document.getElementById('rep-product').value,
    issue:document.getElementById('rep-issue').value,
    buyer:`${currentUser.name} (${currentUser.email})`
  };
  try{ await db_addBuyerReport(data); alert('Report submitted.'); document.getElementById('rep-issue').value=''; }catch(e){ alert('Failed: '+e.message); }
};
document.getElementById('fb-submit').onclick=()=>{
  const t=document.getElementById('fb-text').value.trim(); if(!t) return;
  const arr=JSON.parse(localStorage.getItem('fb')||'[]'); arr.unshift({u:currentUser?.name||'User',t,ts:Date.now()});
  localStorage.setItem('fb',JSON.stringify(arr)); document.getElementById('fb-text').value=''; renderFeedback();
};
function renderFeedback(){
  const list = JSON.parse(localStorage.getItem('fb')||'[]');
  document.getElementById('fb-list').innerHTML = list.map(x=>`<div style="border-bottom:1px solid #F9E6E4;padding:.6rem 0"><b>${x.u}</b><div class="note">${new Date(x.ts).toLocaleString()}</div><div>${x.t}</div></div>`).join('');
}

/* ===== AUTH (local) ===== */
function refreshAuthUI(){
  const authBtns=document.getElementById('auth-buttons'); const uibox=document.getElementById('user-info');
  if(currentUser){ authBtns.style.display='none'; uibox.style.display='flex'; document.getElementById('user-name').innerText=currentUser.name; document.getElementById('user-avatar').innerText=(currentUser.name||'?').charAt(0).toUpperCase(); document.getElementById('fb-gate').style.display='none'; document.getElementById('fb-form').style.display='block'; document.getElementById('report-gate').style.display='none'; document.getElementById('report-form').style.display='block'; }
  else{ authBtns.style.display='block'; uibox.style.display='none'; document.getElementById('fb-gate').style.display='block'; document.getElementById('fb-form').style.display='none'; document.getElementById('report-gate').style.display='block'; document.getElementById('report-form').style.display='none';}
}
function getSavedUser(){ const s=localStorage.getItem('aiaxcart_current_user'); return s?JSON.parse(s):null; }
function saveUser(u){ currentUser=u; if(u) localStorage.setItem('aiaxcart_current_user',JSON.stringify(u)); else localStorage.removeItem('aiaxcart_current_user'); }
function openAuth(){ document.getElementById('authOverlay').style.display='flex'; }
function closeAuth(){ document.getElementById('authOverlay').style.display='none'; document.getElementById('authMsg').innerText=''; }
document.getElementById('tabLogin').onclick=()=>{document.getElementById('formLogin').style.display='block';document.getElementById('formSignup').style.display='none';};
document.getElementById('tabSignup').onclick=()=>{document.getElementById('formLogin').style.display='none';document.getElementById('formSignup').style.display='block';};
document.getElementById('btnLoginGo').onclick=()=>{ const email=liEmail.value.trim(), pass=liPass.value; const users=JSON.parse(localStorage.getItem('aiaxcart_users')||'[]'); const u=users.find(x=>x.email===email&&x.password===pass); if(!u){authMsg.innerText='Invalid credentials';return;} saveUser(u); refreshAuthUI(); closeAuth(); };
document.getElementById('btnSignupGo').onclick=()=>{ const name=suName.value.trim(), email=suEmail.value.trim(), pass=suPass.value, p2=suPass2.value; if(!name||!email||!pass||pass!==p2){authMsg.innerText='Fill all fields correctly.';return;} const users=JSON.parse(localStorage.getItem('aiaxcart_users')||'[]'); if(users.some(x=>x.email===email)){authMsg.innerText='Email already exists.';return;} const u={id:Date.now(),name,email,password:pass,joinDate:new Date().toISOString()}; users.push(u); localStorage.setItem('aiaxcart_users',JSON.stringify(users)); saveUser(u); refreshAuthUI(); closeAuth(); };

/* ===== REALTIME ===== */
db_subscribeStockAndOrders(()=>{ renderProducts(); });

/* ===== START ===== */
refreshAuthUI(); renderProducts(); renderFeedback(); renderRules(); renderAccountTab();
(function(){var ok=localStorage.getItem('ad-ok')==='1';var btn=document.getElementById('admin-btn'); if(btn) btn.style.display=ok?'':'none';})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Aiaxcart Premium Shop</title>
<style>
  body{background:#fefaf7;color:#5a3e36;font-family:'Segoe UI',Tahoma,Verdana,sans-serif;margin:0}
  header{background:#FFD3D6;box-shadow:0 4px 15px rgba(0,0,0,.08)}
  .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .header-content{display:flex;justify-content:space-between;align-items:center;padding:1rem 0}
  nav ul{display:flex;gap:1rem;margin:0;padding:0;list-style:none}
  nav a{color:#5a3e36;text-decoration:none;padding:.5rem 1rem;border-radius:8px}
  nav a.active,nav a:hover{background:#FFC6CA}
  .user-info{display:none;align-items:center;gap:.7rem}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:#FFC6CA;display:grid;place-items:center;font-weight:700}
  .tabs{display:flex;gap:.4rem;background:#fff;border-radius:0 0 12px 12px;padding:.5rem;box-shadow:0 4px 15px rgba(0,0,0,.08);border-top:1px solid #F9E6E4;overflow-x:auto}
  .tab{padding:.6rem 1rem;border-radius:10px;white-space:nowrap;cursor:pointer}
  .tab.active{background:#FFD3D6}
  
  /* Products Grid */
  .products-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:1rem;margin:1.2rem 0}
  .p-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  
  /* Category Sections */
  .category-section{margin:2rem 0}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
  .section-title{margin:0;color:#5a3e36;font-size:1.3rem}
  .view-all{color:#FFB0B5;text-decoration:none;font-weight:600}
  
  .btn{padding:.65rem 1rem;border:none;border-radius:10px;cursor:pointer;font-family:inherit}
  .btn-primary{background:#FFB0B5;color:#fff}
  .btn-primary:disabled{background:#ddd;color:#777}
  .card{background:#fff;border-radius:12px;padding:1.2rem;box-shadow:0 4px 15px rgba(0,0,0,.08);margin:1rem 0}
  .search-wrap{margin:1rem 0;position:relative}
  .search-wrap input{width:100%;padding:.8rem 1rem .8rem 2.4rem;border:1px solid #F9E6E4;border-radius:10px;font-family:inherit}
  .search-wrap span{position:absolute;left:.8rem;top:50%;transform:translateY(-50%)}
  .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#fff3cd;color:#856404;font-size:.8rem;font-weight:700}
  footer{background:#5a3e36;color:#fff;text-align:center;padding:1.2rem 0;margin-top:2rem}
  #toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:99999}
  .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);opacity:.98}
  .toast.ok{background:#28a745}
  .toast.warn{background:#ff9800}
  .toast.err{background:#e74c3c}
  .note{font-size:.85rem;opacity:.8}
  h2.section-title{margin-top:2rem;margin-bottom:.5rem}
  
  /* Category Tabs */
  .category-tabs{display:flex;gap:.5rem;margin:1.5rem 0;overflow-x:auto;padding-bottom:.5rem}
  .category-tab{padding:.6rem 1.2rem;border-radius:999px;background:#fff;border:1px solid #F9E6E4;cursor:pointer;white-space:nowrap;transition:all .3s ease}
  .category-tab.active{background:#FFD3D6;color:#5a3e36;border-color:#FFD3D6}
  
  /* Form elements */
  .row{margin-bottom:1rem}
  .row label{display:block;margin-bottom:.5rem;font-weight:600}
  .row input,.row select,.row textarea{width:100%;padding:.6rem;border:1px solid #E8E8E8;border-radius:8px;font-family:inherit}
  
  /* Content sections */
  .content-section{display:none}
  #products-section{display:block}
  
  /* Modal styles */
  .modal{background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
</style>
</head>
<body>
<div id="toast"></div>
<header>
  <div class="container header-content">
    <div class="logo">üõí Aiaxcart Premium</div>
    <nav>
      <ul>
        <li><a class="active" href="#" data-tab="products">Home</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
    <div id="auth-buttons">
      <button class="btn" id="login-btn">Login / Sign up</button>
    </div>
    <div id="user-info" class="user-info">
      <div id="user-avatar" class="user-avatar"></div>
      <span id="user-name"></span>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </div>
  <div class="container tabs">
    <div class="tab active" data-tab="products">Products</div>
    <div class="tab" data-tab="accounts">My Account</div>
    <div class="tab" data-tab="reports">Report Issue</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="rules">Rules</div>
    <div class="tab" data-tab="feedback">Feedback</div>
    <div class="tab" data-tab="about">About</div>
  </div>
</header>

<main class="container">
  <!-- Products Section -->
  <section id="products-section" class="content-section">
    <div class="search-wrap">
      <span>üîç</span>
      <input id="product-search" placeholder="Search products‚Ä¶"/>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs" id="category-tabs">
      <div class="category-tab active" data-category="all">All Categories</div>
      <div class="category-tab" data-category="entertainment">üé¨ Entertainment</div>
      <div class="category-tab" data-category="streaming">üéß Streaming</div>
      <div class="category-tab" data-category="educational">üìö Educational</div>
      <div class="category-tab" data-category="editing">üé® Editing</div>
      <div class="category-tab" data-category="ai">ü§ñ AI</div>
    </div>

    <div id="categories-container">
      <div class="note">Loading products...</div>
    </div>
  </section>

  <!-- My Account Section -->
  <section id="accounts-content" class="content-section card">
    <div id="account-content">
      <div class="note">Please login to view your account.</div>
    </div>
  </section>

  <!-- Report Issue Section -->
  <section id="reports-content" class="content-section card">
    <h3>Report an Issue</h3>
    <div id="report-gate">
      <div class="note">Please login to report an issue.</div>
    </div>
    <div id="report-form" style="display:none">
      <div class="row">
        <label>Order ID (optional)</label>
        <input id="rep-order" placeholder="Order ID if applicable">
      </div>
      <div class="row">
        <label>Product</label>
        <input id="rep-product" placeholder="Product name">
      </div>
      <div class="row">
        <label>Issue Description</label>
        <textarea id="rep-issue" rows="3" placeholder="Describe the issue you're experiencing"></textarea>
      </div>
      <div class="row">
        <label>Attach screenshot (optional)</label>
        <input id="rep-img" type="file" accept="image/*">
      </div>
      <button class="btn btn-primary" id="rep-submit">Submit Report</button>
    </div>
    <div id="my-reports" style="margin-top:1.5rem"></div>
  </section>

  <!-- Payments Section -->
  <section id="payments-content" class="content-section card">
    <h3>Payment Methods</h3>
    <div class="row">
      <p><strong>GCash:</strong> 0962 554 4105</p>
      <p><strong>Maya:</strong> 0929 984 3629</p>
    </div>
    <div class="note">
      <p>Send payment to the numbers above and include your order ID in the reference/message.</p>
    </div>
  </section>

  <!-- Rules Section -->
  <section id="rules-content" class="content-section card">
    <h3>Store Rules</h3>
    <div class="search-wrap">
      <span>üîç</span>
      <input id="rules-search" placeholder="Search rules‚Ä¶">
    </div>
    <div id="rules-wrap">
      <div class="note">Loading rules...</div>
    </div>
  </section>

  <!-- Feedback Section -->
  <section id="feedback-content" class="content-section card">
    <h3>Customer Feedback</h3>
    <div id="fb-gate">
      <div class="note">Please login to leave feedback.</div>
    </div>
    <div id="fb-form" style="display:none">
      <div class="row">
        <label>Your Feedback</label>
        <textarea id="fb-text" rows="3" placeholder="Share your experience..."></textarea>
      </div>
      <div class="row">
        <label>Attach image (optional)</label>
        <input id="fb-img" type="file" accept="image/*">
      </div>
      <button class="btn btn-primary" id="fb-submit">Submit Feedback</button>
    </div>
    <div id="fb-list" style="margin-top:1.5rem">
      <div class="note">Loading feedback...</div>
    </div>
  </section>

  <!-- About Section -->
  <section id="about-content" class="content-section card">
    <h3>About Aiaxcart Premium</h3>
    <p>Your trusted source for premium digital accounts and subscriptions.</p>
    <div class="note">
      <p>We provide authentic and reliable premium accounts for various streaming, productivity, and entertainment platforms.</p>
    </div>
  </section>
</main>

<footer>
  <div class="container">¬© 2024 Aiaxcart Premium. All rights reserved.</div>
</footer>

<!-- Checkout Modal -->
<div id="coOverlay" class="overlay">
  <div class="modal">
    <h3 id="coTitle">Checkout</h3>
    <form id="coForm">
      <input type="hidden" name="product_id"/>
      <input type="hidden" name="product_name"/>
      <div class="row">
        <label>Buyer Name</label>
        <input required name="buyer_name" placeholder="Your full name">
      </div>
      <div class="row">
        <label>Email</label>
        <input required type="email" name="buyer_email" placeholder="your@email.com">
      </div>
      <div class="row">
        <label>Account Type</label>
        <select name="account_type" required>
          <option value="">Select account type</option>
          <option>Solo Profile</option>
          <option>Shared Profile</option>
          <option>Solo Account</option>
          <option>Shared Account</option>
          <option>Invite</option>
          <option>Family Head</option>
        </select>
      </div>
      <div class="row" id="inviteGmailRow" style="display:none">
        <label>Gmail for Invite</label>
        <input type="email" name="invite_gmail" placeholder="yourgmail@gmail.com">
        <div class="note">Required when Account Type is "Invite"</div>
      </div>
      <div class="row">
        <label>Duration</label>
        <select name="duration_key" required>
          <option value="">Select duration</option>
          <option>7d</option>
          <option>14d</option>
          <option>1m</option>
          <option>2m</option>
          <option>3m</option>
          <option>6m</option>
          <option>12m</option>
        </select>
      </div>
      <div class="row">
        <label>Price (‚Ç±)</label>
        <input type="number" step="0.01" required name="price" placeholder="0.00">
      </div>
      <div style="display:flex;gap:.6rem;margin-top:.9rem">
        <button type="button" class="btn" onclick="closeCheckout()">Cancel</button>
        <button id="coSubmit" type="submit" class="btn btn-primary">Place Order</button>
      </div>
    </form>
    <div id="coMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authOverlay" class="overlay">
  <div class="modal">
    <div style="display:flex;gap:.4rem;margin-bottom:.6rem">
      <button id="tabLogin" class="btn btn-primary">Login</button>
      <button id="tabSignup" class="btn">Sign up</button>
      <button style="margin-left:auto" class="btn" onclick="closeAuth()">√ó</button>
    </div>
    <div id="formLogin">
      <div class="row">
        <label>Email</label>
        <input id="liEmail" type="email" placeholder="your@email.com">
      </div>
      <div class="row">
        <label>Password</label>
        <input id="liPass" type="password" placeholder="Your password">
      </div>
      <button class="btn btn-primary" id="btnLoginGo" style="width:100%">Login</button>
    </div>
    <div id="formSignup" style="display:none">
      <div class="row">
        <label>Full name</label>
        <input id="suName" placeholder="Your full name">
      </div>
      <div class="row">
        <label>Email</label>
        <input id="suEmail" type="email" placeholder="your@email.com">
      </div>
      <div class="row">
        <label>Password</label>
        <input id="suPass" type="password" placeholder="Create password">
      </div>
      <div class="row">
        <label>Confirm Password</label>
        <input id="suPass2" type="password" placeholder="Confirm password">
      </div>
      <button class="btn btn-primary" id="btnSignupGo" style="width:100%">Create Account</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:.5rem;text-align:center"></div>
  </div>
</div>

<!-- CONFIG -->
<script>
window.CONFIG_PUBLIC = {
  DATABASE:{
    SUPABASE_URL:"https://oujvsjnbxmgpdoftzpxl.supabase.co",
    SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91anZzam5ieG1ncGRvZnR6cHhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzE1NTYsImV4cCI6MjA3ODQ0NzU1Nn0.vs06C-2kx4H2whyTReUPsVgLYhWotfkzetxdKD5LVQo"
  },
  ADMIN:{ OWNER_UID:"2ece6eb8-ed7d-4e52-b1b8-f9220fb87e36" }
};
</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/js/aiaxcart/supabase.js?v=6"></script>

<script>
// === Helpers ===
const SB = (window.createDbClient) ? window.createDbClient() : null;
const $  = (id) => document.getElementById(id);

// Demo products data (fallback)
const DEMO_PRODUCTS = [
  { id: 'netflix-premium',  name: 'Netflix Premium',  category: 'entertainment', icon: 'üé¨', available: 5, price: 149 },
  { id: 'spotify-premium',  name: 'Spotify Premium',  category: 'streaming',     icon: 'üéß', available: 8, price: 99  },
  { id: 'youtube-premium',  name: 'YouTube Premium',  category: 'streaming',     icon: 'üì∫', available: 0, price: 199 },
  { id: 'disney-plus',      name: 'Disney+',          category: 'entertainment', icon: 'üè∞', available: 3, price: 129 },
  { id: 'canva-pro',        name: 'Canva Pro',        category: 'editing',       icon: 'üé®', available: 6, price: 199 },
  { id: 'chatgpt-plus',     name: 'ChatGPT Plus',     category: 'ai',            icon: 'ü§ñ', available: 4, price: 299 }
];

// Toast
function toast(msg, type = 'ok') {
  const box = $('#toast');
  if (!box) return;
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(() => {
    el.style.opacity = '0';
    setTimeout(() => el.remove(), 300);
  }, 3000);
}

// Auth state
let currentUser = null;
try {
  currentUser = JSON.parse(localStorage.getItem('aiaxcart_current_user') || 'null');
} catch(_) {
  currentUser = null;
}

function saveUser(user) {
  currentUser = user;
  if (user) {
    localStorage.setItem('aiaxcart_current_user', JSON.stringify(user));
  } else {
    localStorage.removeItem('aiaxcart_current_user');
  }
  refreshAuthUI();
  refreshContentSections();
}

function openAuth() {
  const ov = $('#authOverlay');
  if (ov) ov.style.display = 'flex';
}

function closeAuth() {
  const ov = $('#authOverlay');
  const msg = $('#authMsg');
  if (ov) ov.style.display = 'none';
  if (msg) msg.textContent = '';
}

function refreshAuthUI() {
  const authBtn = $('#auth-buttons');
  const userInfo = $('#user-info');
  const nameEl = $('#user-name');
  const avatarEl = $('#user-avatar');

  if (!authBtn || !userInfo) return;

  if (currentUser) {
    authBtn.style.display = 'block'; // show login container
    authBtn.style.display = 'none';  // but hide button itself
    userInfo.style.display = 'flex';
    if (nameEl)   nameEl.textContent   = currentUser.name;
    if (avatarEl) avatarEl.textContent = (currentUser.name || '?').charAt(0).toUpperCase();
  } else {
    authBtn.style.display = 'block';
    userInfo.style.display = 'none';
  }
}

function refreshContentSections() {
  const repGate = $('#report-gate');
  const repForm = $('#report-form');
  const fbGate  = $('#fb-gate');
  const fbForm  = $('#fb-form');

  if (currentUser) {
    if (repGate) repGate.style.display = 'none';
    if (repForm) repForm.style.display = 'block';
    if (fbGate)  fbGate.style.display  = 'none';
    if (fbForm)  fbForm.style.display  = 'block';
  } else {
    if (repGate) repGate.style.display = 'block';
    if (repForm) repForm.style.display = 'none';
    if (fbGate)  fbGate.style.display  = 'block';
    if (fbForm)  fbForm.style.display  = 'none';
  }

  updateAccountTab();
}

/* ===== Auth Handlers ===== */
function handleLogin() {
  const emailEl = $('#liEmail');
  const passEl  = $('#liPass');
  const msgEl   = $('#authMsg');
  if (!emailEl || !passEl || !msgEl) return;

  const email = emailEl.value.trim();
  const password = passEl.value;

  if (!email || !password) {
    msgEl.textContent = 'Please enter email and password.';
    return;
  }

  let users = [];
  try {
    users = JSON.parse(localStorage.getItem('aiaxcart_users') || '[]');
  } catch(_) {
    users = [];
  }
  const user = users.find(u => u.email === email && u.password === password);

  if (!user) {
    msgEl.textContent = 'Invalid email or password.';
    return;
  }

  saveUser(user);
  closeAuth();
  toast('Welcome back!', 'ok');
}

function handleSignup() {
  const nameEl = $('#suName');
  const emailEl = $('#suEmail');
  const passEl  = $('#suPass');
  const pass2El = $('#suPass2');
  const msgEl   = $('#authMsg');

  if (!nameEl || !emailEl || !passEl || !pass2El || !msgEl) return;

  const name = nameEl.value.trim();
  const email = emailEl.value.trim();
  const password  = passEl.value;
  const password2 = pass2El.value;

  if (!name || !email || !password) {
    msgEl.textContent = 'Please fill all fields.';
    return;
  }
  if (password !== password2) {
    msgEl.textContent = 'Passwords do not match.';
    return;
  }

  let users = [];
  try {
    users = JSON.parse(localStorage.getItem('aiaxcart_users') || '[]');
  } catch(_) {
    users = [];
  }
  if (users.some(u => u.email === email)) {
    msgEl.textContent = 'Email already exists.';
    return;
  }

  const user = {
    id: Date.now().toString(),
    name,
    email,
    password,
    joinDate: new Date().toISOString()
  };

  users.push(user);
  localStorage.setItem('aiaxcart_users', JSON.stringify(users));

  if (window.db_upsertBuyer) {
    window.db_upsertBuyer(user).catch(console.error);
  }

  saveUser(user);
  closeAuth();
  toast('Account created successfully!', 'ok');
}

/* ===== Products ===== */
function renderProducts() {
  const container = $('#categories-container');
  if (!container) return;
  container.innerHTML = '<div class="note">Loading products...</div>';

  if (window.db_listCatalogWithCounts) {
    window.db_listCatalogWithCounts()
      .then(products => {
        if (products && products.length) displayProducts(products);
        else showDemoProducts();
      })
      .catch(err => {
        console.error(err);
        showDemoProducts();
      });
  } else {
    showDemoProducts();
  }
}

function displayProducts(products) {
  const container = $('#categories-container');
  if (!container) return;
  const byCategory = {};
  products.forEach(p=>{
    const cat = p.category || 'other';
    if (!byCategory[cat]) byCategory[cat] = [];
    byCategory[cat].push(p);
  });

  const categoryOrder = ['entertainment','streaming','educational','editing','ai'];
  const categoryNames = {
    entertainment: 'üé¨ Entertainment',
    streaming:     'üéß Streaming & Music',
    educational:   'üìö Educational',
    editing:       'üé® Editing & Creative',
    ai:            'ü§ñ AI Tools'
  };

  let html = '';
  categoryOrder.forEach(cat=>{
    const list = byCategory[cat];
    if (!list || !list.length) return;

    const display = list.slice(0,3);
    const hasMore = list.length > 3;

    html += `
      <div class="category-section" data-category="${cat}">
        <div class="section-header">
          <h2 class="section-title">${categoryNames[cat] || cat}</h2>
          ${hasMore ? `<a href="#" class="view-all" onclick="showAllCategory('${cat}');return false;">View All</a>` : ''}
        </div>
        <div class="products-grid">
          ${display.map(p=>{
            const hasStock = (p.available || 0) > 0;
            const prices = p.prices || [];
            const minPrice = prices.length
              ? Math.min(...prices.map(x=>x.price_php || 0))
              : (p.price || 0);
            const safeName = (p.name || '').replace(/'/g,"\\'");
            return `
              <div class="p-card" data-name="${(p.name||'').toLowerCase()}">
                <div style="font-weight:700;font-size:1.05rem">${p.icon || 'üõí'} ${p.name}</div>
                <div>${hasStock
                  ? `<span class="pill" style="background:#d4edda;color:#155724">${p.available} available</span>`
                  : `<span class="pill">Out of stock</span>`}</div>
                <div class="note">From ‚Ç±${minPrice}</div>
                <button class="btn btn-primary" ${hasStock ? '' : 'disabled'}
                  onclick="openCheckout('${p.id}','${safeName}')">
                  ${hasStock ? 'Buy Now' : 'Unavailable'}
                </button>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  });

  container.innerHTML = html || '<div class="note">No products available.</div>';
}

function showDemoProducts() {
  const container = $('#categories-container');
  if (!container) return;
  const byCategory = {};
  DEMO_PRODUCTS.forEach(p=>{
    if (!byCategory[p.category]) byCategory[p.category] = [];
    byCategory[p.category].push(p);
  });

  const categoryOrder = ['entertainment','streaming','educational','editing','ai'];
  const categoryNames = {
    entertainment: 'üé¨ Entertainment',
    streaming:     'üéß Streaming & Music',
    educational:   'üìö Educational',
    editing:       'üé® Editing & Creative',
    ai:            'ü§ñ AI Tools'
  };

  let html = '';
  categoryOrder.forEach(cat=>{
    const list = byCategory[cat];
    if (!list || !list.length) return;
    html += `
      <div class="category-section" data-category="${cat}">
        <div class="section-header">
          <h2 class="section-title">${categoryNames[cat] || cat}</h2>
        </div>
        <div class="products-grid">
          ${list.map(p=>`
            <div class="p-card" data-name="${p.name.toLowerCase()}">
              <div style="font-weight:700;font-size:1.05rem">${p.icon} ${p.name}</div>
              <div>${p.available>0
                ? `<span class="pill" style="background:#d4edda;color:#155724">${p.available} available</span>`
                : `<span class="pill">Out of stock</span>`}</div>
              <div class="note">From ‚Ç±${p.price}</div>
              <button class="btn btn-primary" ${p.available>0 ? '' : 'disabled'}
                onclick="openCheckout('${p.id}','${p.name.replace(/'/g,"\\'")}')">
                ${p.available>0 ? 'Buy Now' : 'Unavailable'}
              </button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  });
  container.innerHTML = html;
}

function filterProductsByCategory(category) {
  document.querySelectorAll('.category-section').forEach(sec=>{
    if (category === 'all') {
      sec.style.display = 'block';
    } else {
      sec.style.display = (sec.dataset.category === category) ? 'block' : 'none';
    }
  });
}

function showAllCategory(category) {
  filterProductsByCategory(category);
  toast(`Showing all ${category} products`, 'ok');
}

/* ===== Checkout ===== */
function openCheckout(productId, productName) {
  const form = $('#coForm');
  const overlay = $('#coOverlay');
  if (!form || !overlay) return;

  form.product_id.value = productId;
  form.product_name.value = productName;
  const title = $('#coTitle');
  if (title) title.textContent = `Checkout ‚Ä¢ ${productName}`;

  if (currentUser) {
    form.buyer_name.value  = currentUser.name;
    form.buyer_email.value = currentUser.email;
  }

  overlay.style.display = 'flex';
}

function closeCheckout() {
  const overlay = $('#coOverlay');
  const msg = $('#coMsg');
  if (overlay) overlay.style.display = 'none';
  if (msg) msg.textContent = '';
}

async function handleCheckout(e) {
  e.preventDefault();
  const form = e.target;
  const btn  = $('#coSubmit');
  const msg  = $('#coMsg');
  if (!form || !btn) return;

  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    const buyer_name   = form.buyer_name.value.trim();
    const buyer_email  = form.buyer_email.value.trim();
    const product_id   = form.product_id.value;
    const product_name = form.product_name.value;
    const account_type = form.account_type.value;
    const duration_key = form.duration_key.value;
    const price        = parseFloat(form.price.value || 0);
    const invite_gmail = form.invite_gmail ? form.invite_gmail.value.trim() : null;

    if (!buyer_name || !buyer_email || !product_id || !account_type || !duration_key || !price) {
      throw new Error('Please fill all required fields.');
    }
    if ((account_type || '').toLowerCase() === 'invite') {
      if (!invite_gmail || !/^[^@]+@gmail\.com$/i.test(invite_gmail)) {
        throw new Error('Invite type requires a valid Gmail address.');
      }
    }

    let orderId;
    if (window.db_createOrder) {
      const order = await window.db_createOrder({
        buyer_name,
        buyer_email,
        product_id,
        product_name,
        account_type,
        duration_key,
        price,
        invite_gmail
      });
      orderId = order.id;
    } else {
      orderId = 'AXP-' + Date.now();
    }

    if (msg) msg.textContent = `‚úÖ Order placed! Order ID: ${orderId}`;
    toast('Order placed successfully!', 'ok');

    setTimeout(()=>{
      closeCheckout();
      renderProducts();
      updateAccountTab();
    }, 1500);
  } catch(err) {
    console.error(err);
    toast('Checkout failed: ' + err.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Place Order';
  }
}

/* ===== Rules ===== */
function loadRules() {
  const wrap = $('#rules-wrap');
  const search = $('#rules-search');
  if (!wrap) return;

  wrap.innerHTML = `
    <div class="note">
      <h4>General Rules</h4>
      <p>‚Ä¢ All sales are final - no refunds after account delivery.</p>
      <p>‚Ä¢ Accounts are for personal use only.</p>
      <p>‚Ä¢ Keep your login credentials secure.</p>
      <p>‚Ä¢ Report any issues within 24 hours of receiving the account.</p>
      <p>‚Ä¢ Sharing accounts outside agreed terms may result in suspension.</p>
    </div>
  `;

  if (search && !search._bound) {
    search._bound = true;
    search.addEventListener('input', e=>{
      const q = e.target.value.toLowerCase();
      wrap.querySelectorAll('p').forEach(p=>{
        p.style.display = p.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  }
}

/* ===== Reports ===== */
function handleReport() {
  if (!currentUser) {
    toast('Please login to submit a report.', 'warn');
    return;
  }

  const orderEl = $('#rep-order');
  const prodEl  = $('#rep-product');
  const issueEl = $('#rep-issue');
  const imgEl   = $('#rep-img');
  if (!orderEl || !prodEl || !issueEl) return;

  const orderId = orderEl.value.trim();
  const product = prodEl.value.trim();
  const issue   = issueEl.value.trim();
  const file    = imgEl && imgEl.files && imgEl.files[0] ? imgEl.files[0] : null;

  if (!issue) {
    toast('Please describe the issue', 'warn');
    return;
  }

  if (window.db_addBuyerReport) {
    window.db_addBuyerReport({
      order_id: orderId || null,
      product: product || null,
      issue,
      buyer: currentUser.name,
      email: currentUser.email,
      file
    }).then(()=>{
      toast('Report submitted successfully!', 'ok');
      orderEl.value = '';
      prodEl.value  = '';
      issueEl.value = '';
      if (imgEl) imgEl.value = '';
      loadUserReports();
    }).catch(err=>{
      console.error(err);
      toast('Failed to submit report', 'err');
    });
  } else {
    toast('Report submitted successfully! (demo)', 'ok');
    orderEl.value = '';
    prodEl.value  = '';
    issueEl.value = '';
    if (imgEl) imgEl.value = '';
  }
}

async function loadUserReports() {
  const box = $('#my-reports');
  if (!box || !currentUser) return;

  if (!window.db_fetchBuyerReports) {
    box.innerHTML = '<div class="note">No reports yet.</div>';
    return;
  }

  try {
    const list = await window.db_fetchBuyerReports(currentUser.email);
    if (!list || !list.length) {
      box.innerHTML = '<div class="note">No reports yet.</div>';
      return;
    }

    const html = await Promise.all(list.map(async r=>{
      let img = '';
      if (r.image_path && window.getPublicURL) {
        const url = await window.getPublicURL(r.image_path);
        img = `<div style="margin-top:.5rem"><img src="${url}" style="max-width:220px;border-radius:8px"></div>`;
      }
      return `
        <div class="card">
          <div><b>Report ID:</b> ${r.id}</div>
          <div><b>Order ID:</b> ${r.order_id || 'N/A'}</div>
          <div><b>Product:</b> ${r.product || 'N/A'}</div>
          <div><b>Issue:</b> ${r.issue}</div>
          <div><b>Status:</b> <span class="pill" style="background:${r.status==='resolved'?'#d4edda':'#fff3cd'};color:${r.status==='resolved'?'#155724':'#856404'}">${r.status || 'pending'}</span></div>
          <div class="note">${new Date(r.created_at).toLocaleString()}</div>
          ${img}
        </div>
      `;
    }));
    box.innerHTML = html.join('');
  } catch(err) {
    console.error(err);
    box.innerHTML = '<div class="note">Failed to load reports.</div>';
  }
}

/* ===== Feedback ===== */
function handleFeedback() {
  if (!currentUser) {
    toast('Please login to submit feedback.', 'warn');
    return;
  }
  const textEl = $('#fb-text');
  const imgEl  = $('#fb-img');
  if (!textEl) return;

  const text = textEl.value.trim();
  const file = imgEl && imgEl.files && imgEl.files[0] ? imgEl.files[0] : null;

  if (!text) {
    toast('Please enter your feedback', 'warn');
    return;
  }

  if (window.db_addFeedback) {
    window.db_addFeedback({ user: currentUser.name, text, file })
      .then(()=>{
        toast('Thank you for your feedback!', 'ok');
        textEl.value = '';
        if (imgEl) imgEl.value = '';
        loadFeedback();
      })
      .catch(err=>{
        console.error(err);
        toast('Failed to submit feedback', 'err');
      });
  } else {
    toast('Thank you for your feedback! (demo)', 'ok');
    textEl.value = '';
    if (imgEl) imgEl.value = '';
  }
}

async function loadFeedback() {
  const box = $('#fb-list');
  if (!box) return;

  if (!window.db_fetchFeedback) {
    box.innerHTML = `
      <div class="card">
        <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">
          <div class="user-avatar" style="background:#FFD3D6">J</div>
          <div>
            <strong>Juan Dela Cruz</strong>
            <div class="note">2 days ago</div>
          </div>
        </div>
        <div>Great service! My Netflix account was delivered instantly. Will buy again! üëç</div>
      </div>
    `;
    return;
  }

  try {
    const list = await window.db_fetchFeedback();
    if (!list || !list.length) {
      box.innerHTML = '<div class="note">No feedback yet.</div>';
      return;
    }
    box.innerHTML = list.map(f=>{
      const initial = (f.user || '?')[0]?.toUpperCase?.() || 'U';
      return `
        <div class="card">
          <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">
            <div class="user-avatar" style="background:#FFD3D6;width:32px;height:32px">${initial}</div>
            <div>
              <strong>${f.user || 'User'}</strong>
              <div class="note">${new Date(f.created_at || Date.now()).toLocaleString()}</div>
            </div>
          </div>
          <div>${f.text || ''}</div>
        </div>
      `;
    }).join('');
  } catch(err) {
    console.error(err);
    box.innerHTML = '<div class="note">Failed to load feedback.</div>';
  }
}

/* ===== Account Tab ===== */
async function updateAccountTab() {
  const accountContent = $('#account-content');
  if (!accountContent) return;

  if (!currentUser) {
    accountContent.innerHTML = '<div class="note">Please login to view your account information and orders.</div>';
    return;
  }

  let orders = [];
  if (window.db_listOrdersByEmail) {
    try {
      orders = await window.db_listOrdersByEmail(currentUser.email);
    } catch(err) {
      console.error(err);
    }
  }

  const pending   = orders.filter(o=>o.status === 'pending');
  const confirmed = orders.filter(o=>o.status === 'confirmed');

  const renderOrders = (arr) => {
    if (!arr.length) return '<div class="note">None.</div>';
    return arr.map(o=>`
      <div class="card">
        <div><b>${o.product_name}</b> ‚Ä¢ ${o.account_type} ‚Ä¢ ${o.duration_key}</div>
        <div class="note">Order ID: ${o.id}</div>
        <div class="note">Placed: ${new Date(o.created_at).toLocaleString()}</div>
        <div class="note">Status: ${o.status}</div>
      </div>
    `).join('');
  };

  accountContent.innerHTML = `
    <h3>My Account</h3>
    <div class="card">
      <h4>Profile Information</h4>
      <p><strong>Name:</strong> ${currentUser.name}</p>
      <p><strong>Email:</strong> ${currentUser.email}</p>
      <p><strong>Member since:</strong> ${new Date(currentUser.joinDate).toLocaleDateString()}</p>
    </div>
    <div class="card">
      <h4>Pending Orders</h4>
      ${renderOrders(pending)}
    </div>
    <div class="card">
      <h4>Confirmed Orders</h4>
      ${renderOrders(confirmed)}
    </div>
  `;
}

/* ===== INIT ===== */
function initAiax() {
  try {
    // Auth buttons
    const loginBtn  = $('#login-btn');
    const logoutBtn = $('#logout-btn');
    if (loginBtn)  loginBtn.addEventListener('click', openAuth);
    if (logoutBtn) logoutBtn.addEventListener('click', ()=>{ saveUser(null); toast('Logged out successfully','ok'); });

    // Auth tabs
    const tabLogin  = $('#tabLogin');
    const tabSignup = $('#tabSignup');
    const formLogin = $('#formLogin');
    const formSu    = $('#formSignup');
    if (tabLogin && tabSignup && formLogin && formSu) {
      tabLogin.addEventListener('click', ()=>{
        formLogin.style.display = 'block';
        formSu.style.display    = 'none';
        tabLogin.classList.add('btn-primary');
        tabSignup.classList.remove('btn-primary');
      });
      tabSignup.addEventListener('click', ()=>{
        formLogin.style.display = 'none';
        formSu.style.display    = 'block';
        tabSignup.classList.add('btn-primary');
        tabLogin.classList.remove('btn-primary');
      });
    }

    const btnLoginGo  = $('#btnLoginGo');
    const btnSignupGo = $('#btnSignupGo');
    if (btnLoginGo)  btnLoginGo.addEventListener('click', handleLogin);
    if (btnSignupGo) btnSignupGo.addEventListener('click', handleSignup);

    // Main tabs (Products / Accounts / etc.)
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click', function(){
        const targetTab = this.dataset.tab;
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.content-section').forEach(sec=>sec.style.display='none');
        if (targetTab === 'products') {
          const s = $('#products-section');
          if (s) s.style.display = 'block';
        } else {
          const s = $(targetTab + '-content');
          if (s) s.style.display = 'block';
        }
        if (targetTab === 'rules')    loadRules();
        if (targetTab === 'feedback') loadFeedback();
        if (targetTab === 'accounts') updateAccountTab();
        if (targetTab === 'reports' && currentUser) loadUserReports();
      });
    });

    // Category tabs
    document.querySelectorAll('.category-tab').forEach(tab=>{
      tab.addEventListener('click', function(){
        document.querySelectorAll('.category-tab').forEach(t=>t.classList.remove('active'));
        this.classList.add('active');
        filterProductsByCategory(this.dataset.category);
      });
    });

    // Product search
    const search = $('#product-search');
    if (search) {
      search.addEventListener('input', e=>{
        const q = e.target.value.toLowerCase();
        document.querySelectorAll('.p-card').forEach(card=>{
          const name = card.dataset.name || '';
          card.style.display = name.includes(q) ? 'block' : 'none';
        });
      });
    }

// Checkout form
    const coForm = $('#coForm');
    if (coForm) {
      coForm.addEventListener('submit', handleCheckout);
      const accType = coForm.querySelector('select[name="account_type"]');
      const inviteRow = $('#inviteGmailRow');
      if (accType && inviteRow) {
        accType.addEventListener('change', e=>{
          inviteRow.style.display =
            (e.target.value || '').toLowerCase() === 'invite' ? 'block' : 'none';
        });
      }
    }

    // Report & feedback buttons
    const repBtn = $('#rep-submit');
    if (repBtn) repBtn.addEventListener('click', handleReport);
    const fbBtn = $('#fb-submit');
    if (fbBtn) fbBtn.addEventListener('click', handleFeedback);

    // Initial render
    refreshAuthUI();
    refreshContentSections();
    renderProducts();
    loadRules();
    loadFeedback();
  } catch (e) {
    console.error('Init error:', e);
    alert('JS error: ' + e.message);
  }
}

document.addEventListener('DOMContentLoaded', initAiax);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Aiaxcart Premium Shop</title>
<style>
  body{background:#fefaf7;color:#5a3e36;font-family:'Segoe UI',Tahoma,Verdana,sans-serif;margin:0}
  header{background:#FFD3D6;box-shadow:0 4px 15px rgba(0,0,0,.08)}
  .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .header-content{display:flex;justify-content:space-between;align-items:center;padding:1rem 0}
  nav ul{display:flex;gap:1rem;margin:0;padding:0;list-style:none}
  nav a{color:#5a3e36;text-decoration:none;padding:.5rem 1rem;border-radius:8px}
  nav a.active,nav a:hover{background:#FFC6CA}
  .user-info{display:none;align-items:center;gap:.7rem}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:#FFC6CA;display:grid;place-items:center;font-weight:700}
  .tabs{display:flex;gap:.4rem;background:#fff;border-radius:0 0 12px 12px;padding:.5rem;box-shadow:0 4px 15px rgba(0,0,0,.08);border-top:1px solid #F9E6E4;overflow-x:auto}
  .tab{padding:.6rem 1rem;border-radius:10px;white-space:nowrap;cursor:pointer}
  .tab.active{background:#FFD3D6}
  
  /* Products Grid */
  .products-grid{display:flex;flex-direction:column;gap:1rem;margin:1.2rem 0}
  .p-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  
  /* Category Sections */
  .category-section{margin:2rem 0}
  .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
  .section-title{margin:0;color:#5a3e36;font-size:1.3rem}
  .view-all{color:#FFB0B5;text-decoration:none;font-weight:600}
  
  .btn{padding:.65rem 1rem;border:none;border-radius:10px;cursor:pointer;font-family:inherit}
  .btn-primary{background:#FFB0B5;color:#fff}
  .btn-primary:disabled{background:#ddd;color:#777}
  .card{background:#fff;border-radius:12px;padding:1.2rem;box-shadow:0 4px 15px rgba(0,0,0,.08);margin:1rem 0}
  .search-wrap{margin:1rem 0;position:relative}
  .search-wrap input{width:100%;padding:.8rem 1rem .8rem 2.4rem;border:1px solid #F9E6E4;border-radius:10px;font-family:inherit}
  .search-wrap span{position:absolute;left:.8rem;top:50%;transform:translateY(-50%)}
  .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#fff3cd;color:#856404;font-size:.8rem;font-weight:700}
  footer{background:#5a3e36;color:#fff;text-align:center;padding:1.2rem 0;margin-top:2rem}
  #toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:99999}
  .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);opacity:.98}
  .toast.ok{background:#28a745}
  .toast.warn{background:#ff9800}
  .toast.err{background:#e74c3c}
  .note{font-size:.85rem;opacity:.8}
  h2.section-title{margin-top:2rem;margin-bottom:.5rem}
  
  /* Category Tabs */
  .category-tabs{display:flex;gap:.5rem;margin:1.5rem 0;overflow-x:auto;padding-bottom:.5rem}
  .category-tab{padding:.6rem 1.2rem;border-radius:999px;background:#fff;border:1px solid #F9E6E4;cursor:pointer;white-space:nowrap;transition:all .3s ease}
  .category-tab.active{background:#FFD3D6;color:#5a3e36;border-color:#FFD3D6}
  
  /* Form elements */
  .row{margin-bottom:1rem}
  .row label{display:block;margin-bottom:.5rem;font-weight:600}
  .row input,.row select,.row textarea{width:100%;padding:.6rem;border:1px solid #E8E8E8;border-radius:8px;font-family:inherit}
  
  /* Content sections */
  .content-section{display:none}
  #products-section{display:block}
</style>
</head>
<body>
<div id="toast"></div>
<header>
  <div class="container header-content">
    <div class="logo">üõí Aiaxcart Premium</div>
    <nav>
      <ul>
        <li><a class="active" href="#" data-tab="products">Home</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
    <div id="auth-buttons">
      <button class="btn" id="login-btn">Login / Sign up</button>
    </div>
    <div id="user-info" class="user-info">
      <div id="user-avatar" class="user-avatar"></div>
      <span id="user-name"></span>
      <button class="btn" id="logout-btn">Logout</button>
    </div>
  </div>
  <div class="container tabs">
    <div class="tab active" data-tab="products">Products</div>
    <div class="tab" data-tab="accounts">My Account</div>
    <div class="tab" data-tab="reports">Report Issue</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="rules">Rules</div>
    <div class="tab" data-tab="feedback">Feedback</div>
    <div class="tab" data-tab="about">About</div>
  </div>
</header>

<main class="container">
  <!-- Products Section -->
  <section id="products-section" class="content-section">
    <div class="search-wrap">
      <span>üîç</span>
      <input id="product-search" placeholder="Search products‚Ä¶"/>
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs" id="category-tabs">
      <div class="category-tab active" data-category="all">All Categories</div>
      <div class="category-tab" data-category="entertainment">üé¨ Entertainment</div>
      <div class="category-tab" data-category="streaming">üéß Streaming</div>
      <div class="category-tab" data-category="educational">üìö Educational</div>
      <div class="category-tab" data-category="editing">üé® Editing</div>
      <div class="category-tab" data-category="ai">ü§ñ AI</div>
    </div>

    <div id="categories-container">
      <div class="note">Loading products...</div>
    </div>
  </section>

  <!-- My Account Section -->
  <section id="accounts-content" class="content-section card">
    <div id="account-content">
      <div class="note">Please login to view your account.</div>
    </div>
  </section>

  <!-- Report Issue Section -->
  <section id="reports-content" class="content-section card">
    <h3>Report an Issue</h3>
    <div id="report-gate">
      <div class="note">Please login to report an issue.</div>
    </div>
    <div id="report-form" style="display:none">
      <div class="row">
        <label>Order ID (optional)</label>
        <input id="rep-order" placeholder="Order ID if applicable">
      </div>
      <div class="row">
        <label>Product</label>
        <input id="rep-product" placeholder="Product name">
      </div>
      <div class="row">
        <label>Issue Description</label>
        <textarea id="rep-issue" rows="3" placeholder="Describe the issue you're experiencing"></textarea>
      </div>
      <div class="row">
        <label>Attach screenshot (optional)</label>
        <input id="rep-img" type="file" accept="image/*">
      </div>
      <button class="btn btn-primary" id="rep-submit">Submit Report</button>
    </div>
    <div id="my-reports" style="margin-top:1.5rem"></div>
  </section>

  <!-- Payments Section -->
  <section id="payments-content" class="content-section card">
    <h3>Payment Methods</h3>
    <div class="row">
      <p><strong>GCash:</strong> 0962 554 4105</p>
      <p><strong>Maya:</strong> 0929 984 3629</p>
    </div>
    <div class="note">
      <p>Send payment to the numbers above and include your order ID in the reference/message.</p>
    </div>
  </section>

  <!-- Rules Section -->
  <section id="rules-content" class="content-section card">
    <h3>Store Rules</h3>
    <div class="search-wrap">
      <span>üîç</span>
      <input id="rules-search" placeholder="Search rules‚Ä¶">
    </div>
    <div id="rules-wrap">
      <div class="note">Loading rules...</div>
    </div>
  </section>

  <!-- Feedback Section -->
  <section id="feedback-content" class="content-section card">
    <h3>Customer Feedback</h3>
    <div id="fb-gate">
      <div class="note">Please login to leave feedback.</div>
    </div>
    <div id="fb-form" style="display:none">
      <div class="row">
        <label>Your Feedback</label>
        <textarea id="fb-text" rows="3" placeholder="Share your experience..."></textarea>
      </div>
      <div class="row">
        <label>Attach image (optional)</label>
        <input id="fb-img" type="file" accept="image/*">
      </div>
      <button class="btn btn-primary" id="fb-submit">Submit Feedback</button>
    </div>
    <div id="fb-list" style="margin-top:1.5rem">
      <div class="note">Loading feedback...</div>
    </div>
  </section>

  <!-- About Section -->
  <section id="about-content" class="content-section card">
    <h3>About Aiaxcart Premium</h3>
    <p>Your trusted source for premium digital accounts and subscriptions.</p>
    <div class="note">
      <p>We provide authentic and reliable premium accounts for various streaming, productivity, and entertainment platforms.</p>
    </div>
  </section>
</main>

<footer>
  <div class="container">¬© 2024 Aiaxcart Premium. All rights reserved.</div>
</footer>

<!-- Checkout Modal -->
<div id="coOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem">
    <h3 id="coTitle">Checkout</h3>
    <form id="coForm">
      <input type="hidden" name="product_id"/>
      <input type="hidden" name="product_name"/>
      <div class="row">
        <label>Buyer Name</label>
        <input required name="buyer_name" placeholder="Your full name">
      </div>
      <div class="row">
        <label>Email</label>
        <input required type="email" name="buyer_email" placeholder="your@email.com">
      </div>
      <div class="row">
        <label>Account Type</label>
        <select name="account_type" required>
          <option value="">Select account type</option>
          <option>Solo Profile</option>
          <option>Shared Profile</option>
          <option>Solo Account</option>
          <option>Shared Account</option>
          <option>Invite</option>
          <option>Family Head</option>
        </select>
      </div>
      <div class="row" id="inviteGmailRow" style="display:none">
        <label>Gmail for Invite</label>
        <input type="email" name="invite_gmail" placeholder="yourgmail@gmail.com">
        <div class="note">Required when Account Type is "Invite"</div>
      </div>
      <div class="row">
        <label>Duration</label>
        <select name="duration_key" required>
          <option value="">Select duration</option>
          <option>7d</option>
          <option>14d</option>
          <option>1m</option>
          <option>2m</option>
          <option>3m</option>
          <option>6m</option>
          <option>12m</option>
        </select>
      </div>
      <div class="row">
        <label>Price (‚Ç±)</label>
        <input type="number" step="0.01" required name="price" placeholder="0.00">
      </div>
      <div style="display:flex;gap:.6rem;margin-top:.9rem">
        <button type="button" class="btn" onclick="closeCheckout()">Cancel</button>
        <button id="coSubmit" type="submit" class="btn btn-primary">Place Order</button>
      </div>
    </form>
    <div id="coMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem">
    <div style="display:flex;gap:.4rem;margin-bottom:.6rem">
      <button id="tabLogin" class="btn btn-primary">Login</button>
      <button id="tabSignup" class="btn">Sign up</button>
      <button style="margin-left:auto" class="btn" onclick="closeAuth()">√ó</button>
    </div>
    <div id="formLogin">
      <div class="row">
        <label>Email</label>
        <input id="liEmail" type="email" placeholder="your@email.com">
      </div>
      <div class="row">
        <label>Password</label>
        <input id="liPass" type="password" placeholder="Your password">
      </div>
      <button class="btn btn-primary" id="btnLoginGo" style="width:100%">Login</button>
    </div>
    <div id="formSignup" style="display:none">
      <div class="row">
        <label>Full name</label>
        <input id="suName" placeholder="Your full name">
      </div>
      <div class="row">
        <label>Email</label>
        <input id="suEmail" type="email" placeholder="your@email.com">
      </div>
      <div class="row">
        <label>Password</label>
        <input id="suPass" type="password" placeholder="Create password">
      </div>
      <div class="row">
        <label>Confirm Password</label>
        <input id="suPass2" type="password" placeholder="Confirm password">
      </div>
      <button class="btn btn-primary" id="btnSignupGo" style="width:100%">Create Account</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:.5rem;text-align:center"></div>
  </div>
</div>

<!-- CONFIG -->
<script>
window.CONFIG_PUBLIC = {
  DATABASE:{
    SUPABASE_URL:"https://oujvsjnbxmgpdoftzpxl.supabase.co",
    SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91anZzam5ieG1ncGRvZnR6cHhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzE1NTYsImV4cCI6MjA3ODQ0NzU1Nn0.vs06C-2kx4H2whyTReUPsVgLYhWotfkzetxdKD5LVQo"
  },
  ADMIN:{ OWNER_UID:"2ece6eb8-ed7d-4e52-b1b8-f9220fb87e36" }
};
</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/js/aiaxcart/supabase.js?v=6"></script>

<script>
const SB = createDbClient();
const $ = (id) => document.getElementById(id);

// Demo catalog for testing
window.AIAX_CATALOG = [
  {
    id: 'netflix-premium',
    name: 'Netflix Premium',
    category: 'entertainment',
    icon: 'üé¨',
    pricing: {
      'Solo Account': {'1m': 149, '3m': 399},
      'Shared Account': {'1m': 99, '3m': 269}
    }
  },
  {
    id: 'spotify-premium',
    name: 'Spotify Premium',
    category: 'streaming',
    icon: 'üéß',
    pricing: {
      'Individual': {'1m': 99, '3m': 269},
      'Family': {'1m': 149, '3m': 399}
    }
  },
  {
    id: 'youtube-premium',
    name: 'YouTube Premium',
    category: 'streaming',
    icon: 'üì∫',
    pricing: {
      'Individual': {'1m': 199, '3m': 549},
      'Family': {'1m': 299, '3m': 799}
    }
  },
  {
    id: 'canva-pro',
    name: 'Canva Pro',
    category: 'editing',
    icon: 'üé®',
    pricing: {
      'Team Account': {'1m': 199, '3m': 549}
    }
  },
  {
    id: 'disney-plus',
    name: 'Disney+',
    category: 'entertainment',
    icon: 'üè∞',
    pricing: {
      'Solo Account': {'1m': 129, '3m': 349}
    }
  },
  {
    id: 'chatgpt-plus',
    name: 'ChatGPT Plus',
    category: 'ai',
    icon: 'ü§ñ',
    pricing: {
      'Individual': {'1m': 299, '3m': 799}
    }
  }
];

/* ===== Toast ===== */
function toast(msg, type='ok'){
  const box = $('#toast');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(() => { 
    el.style.opacity = '0'; 
    setTimeout(() => el.remove(), 300); 
  }, 3000);
}

/* ===== Auth System ===== */
let currentUser = getSavedUser();

function getSavedUser(){
  const s = localStorage.getItem('aiaxcart_current_user');
  return s ? JSON.parse(s) : null;
}

function saveUser(u){
  currentUser = u;
  if(u) {
    localStorage.setItem('aiaxcart_current_user', JSON.stringify(u));
  } else {
    localStorage.removeItem('aiaxcart_current_user');
  }
  refreshAuthUI();
  refreshContentSections();
}

function openAuth(){ 
  $('#authOverlay').style.display = 'flex'; 
}

function closeAuth(){ 
  $('#authOverlay').style.display = 'none'; 
  $('#authMsg').textContent = ''; 
}

function refreshAuthUI(){
  const ab = $('#auth-buttons');
  const ui = $('#user-info');
  if(currentUser){
    ab.style.display = 'none';
    ui.style.display = 'flex';
    $('#user-name').textContent = currentUser.name;
    $('#user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
  } else {
    ab.style.display = 'block';
    ui.style.display = 'none';
  }
}

function refreshContentSections() {
  // Update report section
  if (currentUser) {
    $('#report-gate').style.display = 'none';
    $('#report-form').style.display = 'block';
    loadUserReports();
  } else {
    $('#report-gate').style.display = 'block';
    $('#report-form').style.display = 'none';
    $('#my-reports').innerHTML = '';
  }

  // Update feedback section
  if (currentUser) {
    $('#fb-gate').style.display = 'none';
    $('#fb-form').style.display = 'block';
  } else {
    $('#fb-gate').style.display = 'block';
    $('#fb-form').style.display = 'none';
  }

  // Update account section
  updateAccountTab();
}

// Auth event listeners
$('login-btn').onclick = openAuth;
$('logout-btn').onclick = () => { 
  saveUser(null); 
  toast('Logged out successfully', 'ok'); 
};

/* ===== Tab Navigation ===== */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const targetTab = this.dataset.tab;
    
    // Update active tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    
    // Show target section
    document.querySelectorAll('.content-section').forEach(section => {
      section.style.display = 'none';
    });
    $(targetTab + '-section' || targetTab + '-content').style.display = 'block';
    
    // Load section-specific content
    if(targetTab === 'rules') loadRules();
    if(targetTab === 'feedback') loadFeedback();
    if(targetTab === 'accounts') updateAccountTab();
    if(targetTab === 'reports' && currentUser) loadUserReports();
  });
});

// Home navigation
document.querySelectorAll('nav a[data-tab]').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const targetTab = this.dataset.tab;
    document.querySelectorAll('.tab').forEach(tab => {
      if(tab.dataset.tab === targetTab) {
        tab.click();
      }
    });
  });
});

/* ===== Auth Modal ===== */
$('tabLogin').onclick = () => { 
  $('#formLogin').style.display = 'block'; 
  $('#formSignup').style.display = 'none'; 
  $('#tabLogin').classList.add('btn-primary');
  $('#tabSignup').classList.remove('btn-primary');
};

$('tabSignup').onclick = () => { 
  $('#formLogin').style.display = 'none'; 
  $('#formSignup').style.display = 'block'; 
  $('#tabSignup').classList.add('btn-primary');
  $('#tabLogin').classList.remove('btn-primary');
};

$('btnSignupGo').onclick = async () => {
  const name = $('#suName').value.trim();
  const email = $('#suEmail').value.trim();
  const pass = $('#suPass').value;
  const pass2 = $('#suPass2').value;
  
  if(!name || !email || !pass) { 
    $('#authMsg').textContent = 'Please fill all fields.'; 
    return; 
  }
  if(pass !== pass2) { 
    $('#authMsg').textContent = 'Passwords do not match.'; 
    return; 
  }
  
  let users = JSON.parse(localStorage.getItem('aiaxcart_users') || '[]');
  if(users.some(u => u.email === email)) { 
    $('#authMsg').textContent = 'Email already exists.'; 
    return; 
  }
  
  const user = {
    id: Date.now().toString(),
    name: name,
    email: email,
    password: pass,
    joinDate: new Date().toISOString()
  };
  
  users.push(user);
  localStorage.setItem('aiaxcart_users', JSON.stringify(users));
  
  try {
    await db_upsertBuyer(user);
    saveUser(user);
    closeAuth();
    toast('Account created successfully!', 'ok');
  } catch(error) {
    toast('Error creating account', 'err');
  }
};

$('btnLoginGo').onclick = async () => {
  const email = $('#liEmail').value.trim();
  const pass = $('#liPass').value;
  
  if(!email || !pass) { 
    $('#authMsg').textContent = 'Please enter email and password.'; 
    return; 
  }
  
  const users = JSON.parse(localStorage.getItem('aiaxcart_users') || '[]');
  const user = users.find(u => u.email === email && u.password === pass);
  
  if(!user) { 
    $('#authMsg').textContent = 'Invalid email or password.'; 
    return; 
  }
  
  try {
    await db_upsertBuyer(user);
    saveUser(user);
    closeAuth();
    toast('Welcome back!', 'ok');
  } catch(error) {
    toast('Error logging in', 'err');
  }
};

/* ===== Products System ===== */
async function renderProducts(){
  const container = $('#categories-container');
  container.innerHTML = '<div class="note">Loading products...</div>';

  try {
    // Try to seed with demo catalog
    try {
      await db_seedCatalogIfEmpty(window.AIAX_CATALOG);
    } catch(e) {
      console.log('Seeding may have completed');
    }
    
    const products = await db_listCatalogWithCounts();
    
    if(!products.length){
      showDemoProducts();
      return;
    }

    const byCategory = {};
    products.forEach(product => {
      const category = product.category || 'other';
      if (!byCategory[category]) {
        byCategory[category] = [];
      }
      byCategory[category].push(product);
    });

    const categoryOrder = ['entertainment', 'streaming', 'educational', 'editing', 'ai'];
    let html = '';
    
    categoryOrder.forEach(category => {
      const categoryProducts = byCategory[category];
      if(!categoryProducts || !categoryProducts.length) return;
      
      const categoryNames = {
        entertainment: 'üé¨ Entertainment',
        streaming: 'üéß Streaming & Music', 
        educational: 'üìö Educational',
        editing: 'üé® Editing & Creative',
        ai: 'ü§ñ AI Tools'
      };
      
      // Show only first 3 products
      const displayProducts = categoryProducts.slice(0, 3);
      const hasMore = categoryProducts.length > 3;
      
      html += `
        <div class="category-section" data-category="${category}">
          <div class="section-header">
            <h2 class="section-title">${categoryNames[category] || category}</h2>
            ${hasMore ? `<a href="#" class="view-all" onclick="showAllCategory('${category}')">View All</a>` : ''}
          </div>
          <div class="products-grid">
            ${displayProducts.map(product => {
              const hasStock = (product.available || 0) > 0;
              const prices = product.prices || [];
              const minPrice = prices.length ? 
                Math.min(...prices.map(p => p.price_php)) : 0;
                
              return `
                <div class="p-card" data-name="${product.name.toLowerCase()}">
                  <div style="font-weight:700;font-size:1.05rem">${product.icon || 'üõí'} ${product.name}</div>
                  <div>${hasStock 
                    ? `<span class="pill" style="background:#d4edda;color:#155724">${product.available} available</span>`
                    : `<span class="pill">Out of stock</span>`}</div>
                  <div class="note">From ‚Ç±${minPrice}</div>
                  <button class="btn btn-primary" ${hasStock ? '' : 'disabled'}
                    onclick="openCheckout('${product.id}', '${product.name.replace(/'/g, "\\'")}')">
                    ${hasStock ? 'Buy Now' : 'Unavailable'}
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html || '<div class="note">No products available.</div>';
    
  } catch(error) {
    console.error('Error loading products:', error);
    showDemoProducts();
  }
}

function showDemoProducts() {
  const container = $('#categories-container');
  container.innerHTML = `
    <div class="category-section" data-category="entertainment">
      <div class="section-header">
        <h2 class="section-title">üé¨ Entertainment</h2>
      </div>
      <div class="products-grid">
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üé¨ Netflix Premium</div>
          <div><span class="pill" style="background:#d4edda;color:#155724">5 available</span></div>
          <div class="note">From ‚Ç±149</div>
          <button class="btn btn-primary" onclick="openCheckout('netflix','Netflix Premium')">Buy Now</button>
        </div>
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üè∞ Disney+</div>
          <div><span class="pill" style="background:#d4edda;color:#155724">3 available</span></div>
          <div class="note">From ‚Ç±129</div>
          <button class="btn btn-primary" onclick="openCheckout('disney','Disney+')">Buy Now</button>
        </div>
      </div>
    </div>
    <div class="category-section" data-category="streaming">
      <div class="section-header">
        <h2 class="section-title">üéß Streaming & Music</h2>
      </div>
      <div class="products-grid">
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üéß Spotify Premium</div>
          <div><span class="pill" style="background:#d4edda;color:#155724">8 available</span></div>
          <div class="note">From ‚Ç±99</div>
          <button class="btn btn-primary" onclick="openCheckout('spotify','Spotify Premium')">Buy Now</button>
        </div>
        <div class="p-card">
          <div style="font-weight:700;font-size:1.05rem">üì∫ YouTube Premium</div>
          <div><span class="pill">Out of stock</span></div>
          <div class="note">From ‚Ç±199</div>
          <button class="btn btn-primary" disabled>Unavailable</button>
        </div>
      </div>
    </div>
  `;
}

function showAllCategory(category) {
  filterProductsByCategory(category);
  toast(`Showing all ${category} products`, 'ok');
}

/* ===== Category Filter ===== */
document.querySelectorAll('.category-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    filterProductsByCategory(this.dataset.category);
  });
});

function filterProductsByCategory(category) {
  const sections = document.querySelectorAll('.category-section');
  
  if (category === 'all') {
    sections.forEach(section => section.style.display = 'block');
  } else {
    sections.forEach(section => {
      section.style.display = section.dataset.category === category ? 'block' : 'none';
    });
  }
}

/* ===== Search ===== */
$('product-search').addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase();
  const products = document.querySelectorAll('.p-card');
  
  products.forEach(product => {
    const productName = product.dataset.name || '';
    product.style.display = productName.includes(query) ? 'block' : 'none';
  });
});

/* ===== Checkout System ===== */
function openCheckout(productId, productName){
  const form = $('#coForm');
  form.product_id.value = productId;
  form.product_name.value = productName;
  $('#coTitle').textContent = `Checkout ‚Ä¢ ${productName}`;
  
  if(currentUser){
    form.buyer_name.value = currentUser.name;
    form.buyer_email.value = currentUser.email;
  }
  
  $('#coOverlay').style.display = 'flex';
}

function closeCheckout(){ 
  $('#coOverlay').style.display = 'none'; 
  $('#coMsg').textContent = '';
}

// Show/hide invite email field
$('coForm').account_type.addEventListener('change', function(e) {
  $('#inviteGmailRow').style.display = 
    e.target.value.toLowerCase() === 'invite' ? 'block' : 'none';
});

$('coForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const btn = $('#coSubmit');
  
  btn.disabled = true;
  btn.textContent = 'Processing...';
  
  try {
    if(form.account_type.value.toLowerCase() === 'invite'){
      const gmail = (form.invite_gmail.value || '').trim();
      if(!/^[^@]+@gmail\.com$/i.test(gmail)) {
        throw new Error('Invite requires a valid Gmail address');
      }
    }
    
    const order = await db_createOrder({
      buyer_name: form.buyer_name.value.trim(),
      buyer_email: form.buyer_email.value.trim(),
      product_id: form.product_id.value,
      product_name: form.product_name.value,
      account_type: form.account_type.value,
      duration_key: form.duration_key.value,
      price: parseFloat(form.price.value || 0),
      invite_gmail: form.invite_gmail ? form.invite_gmail.value.trim() : null
    });
    
    $('#coMsg').textContent = `‚úÖ Order placed! Order ID: ${order.id}`;
    toast('Order placed successfully!', 'ok');
    
    setTimeout(() => {
      closeCheckout();
      renderProducts(); // Refresh product availability
      updateAccountTab(); // Refresh orders in account
    }, 2000);
    
  } catch(error) {
    $('#coMsg').textContent = `Error: ${error.message}`;
    toast('Order failed: ' + error.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Place Order';
  }
});

/* ===== Rules System ===== */
async function loadRules(){
  try {
    const rules = await db_fetchRules();
    const rulesWrap = $('#rules-wrap');
    
    if(!rules.length){
      rulesWrap.innerHTML = `
        <div class="note">
          <h4>General Rules</h4>
          <p>‚Ä¢ All sales are final - no refunds after account delivery</p>
          <p>‚Ä¢ Accounts are for personal use only</p>
          <p>‚Ä¢ Keep your login credentials secure</p>
          <p>‚Ä¢ Report any issues within 24 hours</p>
        </div>
      `;
      return;
    }
    
    const byProduct = {};
    rules.forEach(rule => {
      const product = rule.product || 'general';
      if (!byProduct[product]) {
        byProduct[product] = [];
      }
      byProduct[product].push(rule);
    });
    
    let html = '';
    if(byProduct.general){
      html += `<div><h4>General Rules</h4>${byProduct.general.map(r => `<p>‚Ä¢ ${r.text}</p>`).join('')}</div>`;
    }
    
    Object.keys(byProduct).filter(k => k !== 'general').forEach(product => {
      html += `<div style="margin-top:1rem"><h4>${product} Rules</h4>${byProduct[product].map(r => `<p>‚Ä¢ ${r.text}</p>`).join('')}</div>`;
    });
    
    rulesWrap.innerHTML = html;
  } catch(error) {
    $('#rules-wrap').innerHTML = '<div class="note">Error loading rules</div>';
  }
}

// Rules search
$('rules-search').addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase();
  const rules = $('#rules-wrap').querySelectorAll('p');
  
  rules.forEach(rule => {
    rule.style.display = rule.textContent.toLowerCase().includes(query) ? 'block' : 'none';
  });
});

/* ===== Reports System ===== */
$('rep-submit').addEventListener('click', async () => {
  if(!currentUser) return;
  
  const orderId = $('#rep-order').value.trim();
  const product = $('#rep-product').value.trim();
  const issue = $('#rep-issue').value.trim();
  const file = $('#rep-img').files[0];
  
  if(!issue){
    toast('Please describe the issue', 'warn');
    return;
  }
  
  try {
    await db_addBuyerReport({
      order_id: orderId || null,
      product: product || null,
      issue: issue,
      buyer: currentUser.name,
      email: currentUser.email,
      file: file
    });
    
    // Clear form
    $('#rep-order').value = '';
    $('#rep-product').value = '';
    $('#rep-issue').value = '';
    $('#rep-img').value = '';
    
    loadUserReports();
    toast('Report submitted successfully!', 'ok');
  } catch(error) {
    toast('Error submitting report: ' + error.message, 'err');
  }
});

async function loadUserReports(){
  if(!currentUser) return;
  
  try {
    const reports = await db_fetchBuyerReports(currentUser.email);
    const myReports = $('#my-reports');
    
    if(!reports.length){
      myReports.innerHTML = '<div class="note">No reports submitted yet.</div>';
      return;
    }
    
    const html = await Promise.all(reports.map(async report => {
      let imgHtml = '';
      if(report.image_path){
        try {
          const url = await getPublicURL(report.image_path);
          imgHtml = `<div style="margin-top:.5rem"><img src="${url}" style="max-width:200px;border-radius:8px"></div>`;
        } catch(e) {}
      }
      
      const statusColor = report.status === 'resolved' ? '#d4edda' : '#fff3cd';
      const statusTextColor = report.status === 'resolved' ? '#155724' : '#856404';
      
      return `
        <div class="card">
          <div><strong>Report ID:</strong> ${report.id}</div>
          <div><strong>Order:</strong> ${report.order_id || 'N/A'}</div>
          <div><strong>Product:</strong> ${report.product || 'N/A'}</div>
          <div><strong>Issue:</strong> ${report.issue}</div>
          <div><strong>Status:</strong> <span class="pill" style="background:${statusColor};color:${statusTextColor}">${report.status || 'pending'}</span></div>
          <div class="note">Submitted: ${new Date(report.created_at).toLocaleString()}</div>
          ${imgHtml}
        </div>
      `;
    }));
    
    myReports.innerHTML = html.join('');
  } catch(error) {
    $('#my-reports').innerHTML = '<div class="note">Error loading reports</div>';
  }
}

/* ===== Feedback System ===== */
$('fb-submit').addEventListener('click', async () => {
  if(!currentUser) return;
  
  const text = $('#fb-text').value.trim();
  const file = $('#fb-img').files[0];
  
  if(!text){
    toast('Please enter your feedback', 'warn');
    return;
  }
  
  try {
    await db_addFeedback({
      user: currentUser.name,
      text: text,
      file: file
    });
    
    // Clear form
    $('#fb-text').value = '';
    $('#fb-img').value = '';
    
    loadFeedback();
    toast('Thank you for your feedback!', 'ok');
  } catch(error) {
    toast('Error submitting feedback: ' + error.message, 'err');
  }
});

async function loadFeedback(){
  try {
    const feedback = await db_fetchFeedback();
    const fbList = $('#fb-list');
    
    if(!feedback.length){
      fbList.innerHTML = '<div class="note">No feedback yet. Be the first to share!</div>';
      return;
    }
    
    const html = await Promise.all(feedback.map(async item => {
      let imgHtml = '';
      if(item.image_path){
        try {
          const url = await getPublicURL(item.image_path);
          imgHtml = `<div style="margin-top:.5rem"><img src="${url}" style="max-width:200px;border-radius:8px"></div>`;
        } catch(e) {}
      }
      
      const initial = (item.user || 'U')[0].toUpperCase();
      
      return `
        <div class="card">
          <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">
            <div class="user-avatar" style="background:#FFD3D6">${initial}</div>
            <div>
              <strong>${item.user || 'User'}</strong>
              <div class="note">${new Date(item.created_at).toLocaleString()}</div>
            </div>
          </div>
          <div>${item.text}</div>
          ${imgHtml}
        </div>
      `;
    }));
    
    fbList.innerHTML = html.join('');
  } catch(error) {
    $('#fb-list').innerHTML = '<div class="note">Error loading feedback</div>';
  }
}

/* ===== Account System ===== */
async function updateAccountTab(){
  const accountContent = $('#account-content');
  
  if(!currentUser){
    accountContent.innerHTML = '<div class="note">Please login to view your account information and orders.</div>';
    return;
  }
  
  try {
    const orders = await db_listOrdersByEmail(currentUser.email);
    const pendingOrders = orders.filter(o => o.status === 'pending');
    const confirmedOrders = orders.filter(o => o.status === 'confirmed');
    
    accountContent.innerHTML = `
      <h3>My Account</h3>
      <div class="card">
        <h4>Profile Information</h4>
        <p><strong>Name:</strong> ${currentUser.name}</p>
        <p><strong>Email:</strong> ${currentUser.email}</p>
        <p><strong>Member since:</strong> ${new Date(currentUser.joinDate).toLocaleDateString()}</p>
      </div>
      
      <div class="card">
        <h4>Pending Orders (${pendingOrders.length})</h4>
        ${pendingOrders.length ? pendingOrders.map(order => `
          <div style="padding:.5rem 0;border-bottom:1px solid #f0f0f0">
            <div><strong>${order.product_name}</strong> ‚Ä¢ ${order.account_type} ‚Ä¢ ${order.duration_key}</div>
            <div class="note">Order ID: ${order.id} ‚Ä¢ ‚Ç±${order.price_php || 0}</div>
            <div class="note">Placed: ${new Date(order.created_at).toLocaleString()}</div>
          </div>
        `).join('') : '<div class="note">No pending orders</div>'}
      </div>
      
      <div class="card">
        <h4>Confirmed Orders (${confirmedOrders.length})</h4>
        ${confirmedOrders.length ? confirmedOrders.map(order => `
          <div style="padding:.5rem 0;border-bottom:1px solid #f0f0f0">
            <div><strong>${order.product_name}</strong> ‚Ä¢ ${order.account_type} ‚Ä¢ ${order.duration_key}</div>
            <div class="note">Order ID: ${order.id} ‚Ä¢ ‚Ç±${order.price_php || 0}</div>
            <div class="note">Confirmed: ${new Date(order.confirmed_at).toLocaleString()}</div>
          </div>
        `).join('') : '<div class="note">No confirmed orders</div>'}
      </div>
    `;
  } catch(error) {
    accountContent.innerHTML = '<div class="note">Error loading account information</div>';
  }
}

/* ===== Initialize ===== */
document.addEventListener('DOMContentLoaded', async () => {
  refreshAuthUI();
  refreshContentSections();
  await renderProducts();
  await loadRules();
  await loadFeedback();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Aiaxcart Premium Shop</title>
<style>
  body{background:#fefaf7;color:#5a3e36;font-family:'Segoe UI',Tahoma,Verdana,sans-serif;margin:0}
  header{background:#FFD3D6;box-shadow:0 4px 15px rgba(0,0,0,.08)}
  .container{max-width:1200px;margin:0 auto;padding:0 20px}
  .header-content{display:flex;justify-content:space-between;align-items:center;padding:1rem 0}
  nav ul{display:flex;gap:1rem;margin:0;padding:0;list-style:none}
  nav a{color:#5a3e36;text-decoration:none;padding:.5rem 1rem;border-radius:8px}
  nav a.active,nav a:hover{background:#FFC6CA}
  .user-info{display:none;align-items:center;gap:.7rem}
  .user-avatar{width:36px;height:36px;border-radius:50%;background:#FFC6CA;display:grid;place-items:center;font-weight:700}
  .tabs{display:flex;gap:.4rem;background:#fff;border-radius:0 0 12px 12px;padding:.5rem;box-shadow:0 4px 15px rgba(0,0,0,.08);border-top:1px solid #F9E6E4;overflow-x:auto}
  .tab{padding:.6rem 1rem;border-radius:10px;white-space:nowrap;cursor:pointer}
  .tab.active{background:#FFD3D6}
  .products-grid{display:flex;flex-direction:column;gap:1rem;margin:1.2rem 0}
  .p-card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .btn{padding:.65rem 1rem;border:none;border-radius:10px;cursor:pointer}
  .btn-primary{background:#FFB0B5;color:#fff}
  .btn-primary:disabled{background:#ddd;color:#777}
  .card{background:#fff;border-radius:12px;padding:1.2rem;box-shadow:0 4px 15px rgba(0,0,0,.08);margin:1rem 0}
  .search-wrap{margin:1rem 0;position:relative}
  .search-wrap input{width:100%;padding:.8rem 1rem .8rem 2.4rem;border:1px solid #F9E6E4;border-radius:10px}
  .search-wrap span{position:absolute;left:.8rem;top:50%;transform:translateY(-50%)}
  .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#fff3cd;color:#856404;font-size:.8rem;font-weight:700}
  footer{background:#5a3e36;color:#fff;text-align:center;padding:1.2rem 0;margin-top:2rem}
  #toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:99999}
  .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.15);opacity:.98}
  .toast.ok{background:#28a745}
  .toast.warn{background:#ff9800}
  .toast.err{background:#e74c3c}
  .note{font-size:.85rem;color:#555}
</style>
<link rel="stylesheet" href="assets/css/extras.css"/>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="container header-content">
    <div class="logo">üõí Aiaxcart Premium</div>
    <nav>
      <ul>
        <li><a class="active" href="index.html">Home</a></li>
        <li><a id="adminBtn" href="admin.html">Admin</a></li>
      </ul>
    </nav>
    <div id="authButtons">
      <button class="btn" id="loginBtn">Login / Sign up</button>
    </div>
    <div id="userInfo" class="user-info">
      <div id="userAvatar" class="user-avatar"></div>
      <span id="userName"></span>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </div>
  <div class="container tabs">
    <div class="tab active" data-tab="products">Products</div>
    <div class="tab" data-tab="accounts">My Account</div>
    <div class="tab" data-tab="reports">Report Issue</div>
    <div class="tab" data-tab="payments">Payments</div>
    <div class="tab" data-tab="rules">Rules</div>
    <div class="tab" data-tab="feedback">Feedback</div>
    <div class="tab" data-tab="about">About</div>
  </div>
</header>

<main class="container">
  <div class="search-wrap">
    <span>üîç</span>
    <input id="productSearch" placeholder="Search products‚Ä¶"/>
  </div>

  <section id="productsSection" style="margin-top:1.5rem">
    <h2>Products</h2>
    <div id="productsWrap" class="products-grid"></div>
  </section>

  <section id="accountsContent" class="card" style="display:none"></section>

  <section id="reportsContent" class="card" style="display:none">
    <h3>Report an Issue</h3>
    <div id="reportGate" class="note">Please login to report an issue.</div>
    <div id="reportForm" style="display:none">
      <div class="row"><label>Order (optional)</label><input id="repOrder"></div>
      <div class="row"><label>Product</label><input id="repProduct"></div>
      <div class="row"><label>Issue</label><textarea id="repIssue" rows="3"></textarea></div>
      <div class="row"><label>Attach image</label><input id="repImg" type="file" accept="image/*"></div>
      <button class="btn btn-primary" id="repSubmit">Submit Report</button>
    </div>
    <div id="myReports" style="margin-top:1rem"></div>
  </section>

  <section id="paymentsContent" class="card" style="display:none">
    <h3>Payment Methods</h3>
    <p>GCash: <b>0962 554 4105</b></p>
    <p>Maya: <b>0929 984 3629</b></p>
  </section>

  <section id="rulesContent" class="card" style="display:none">
    <h3>Store Rules</h3>
    <div class="row">
      <input id="rulesSearch" placeholder="Search rules‚Ä¶">
    </div>
    <div id="rulesWrap"></div>
  </section>

  <section id="feedbackContent" class="card" style="display:none">
    <h3>Customer Feedback</h3>
    <div id="fbGate" class="note">Please login to leave feedback.</div>
    <div id="fbForm" style="display:none">
      <div class="row"><label>Your feedback</label><textarea id="fbText" rows="3"></textarea></div>
      <div class="row"><label>Attach image (optional)</label><input id="fbImg" type="file" accept="image/*"></div>
      <button class="btn btn-primary" id="fbSubmit">Submit</button>
    </div>
    <div id="fbList" style="margin-top:1rem"></div>
  </section>

  <section id="aboutContent" class="card" style="display:none">
    <p>Aiaxcart Premium ‚Äî Your trusted source for premium digital accounts.</p>
  </section>
</main>

<footer>
  <div class="container">¬© 2024 Aiaxcart Premium. All rights reserved.</div>
</footer>

<!-- Checkout Modal -->
<div id="coOverlay" class="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999">
  <div class="modal" style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem">
    <h3 id="coTitle">Checkout</h3>
    <form id="coForm" onsubmit="return false;">
      <input type="hidden" name="product_id"/>
      <input type="hidden" name="product_name"/>
      <div class="row"><label>Buyer Name</label><input required name="buyer_name"></div>
      <div class="row"><label>Email</label><input required type="email" name="buyer_email"></div>
      <div class="row">
        <label>Account Type</label>
        <select name="account_type" required id="coAccType">
          <option>Solo Profile</option>
          <option>Shared Profile</option>
          <option>Solo Account</option>
          <option>Shared Account</option>
          <option>invite</option>
          <option>famhead</option>
        </select>
      </div>
      <div class="row" id="inviteGmailRow" style="display:none">
        <label>Gmail for Invite</label>
        <input type="email" name="invite_gmail" placeholder="yourgmail@gmail.com">
        <small class="note">Required when Account Type is ‚Äúinvite‚Äù.</small>
      </div>
      <div class="row">
        <label>Duration</label>
        <select name="duration_key" required>
          <option>7d</option><option>14d</option><option>1m</option><option>2m</option>
          <option>3m</option><option>4m</option><option>6m</option><option>8m</option>
          <option>10m</option><option>12m</option>
        </select>
      </div>
      <div class="row"><label>Price (‚Ç±)</label><input type="number" step="0.01" required name="price"></div>
      <div style="display:flex;gap:.6rem;margin-top:.9rem">
        <button type="button" class="btn" id="coCancel">Cancel</button>
        <button id="coSubmit" type="submit" class="btn btn-primary">Place Order</button>
      </div>
    </form>
    <div id="coMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="authOverlay" class="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999">
  <div class="modal" style="background:#fff;border-radius:12px;max-width:480px;width:92%;padding:1.2rem">
    <div style="display:flex;gap:.4rem;margin-bottom:.6rem">
      <button id="tabLogin" class="btn">Login</button>
      <button id="tabSignup" class="btn btn-primary">Sign up</button>
      <button style="margin-left:auto" class="btn" id="authCloseBtn">√ó</button>
    </div>
    <div id="formLogin">
      <div class="row"><label>Email</label><input id="liEmail" type="email"></div>
      <div class="row"><label>Password</label><input id="liPass" type="password"></div>
      <button class="btn btn-primary" id="btnLoginGo">Login</button>
    </div>
    <div id="formSignup" style="display:none">
      <div class="row"><label>Full name</label><input id="suName"></div>
      <div class="row"><label>Email</label><input id="suEmail" type="email"></div>
      <div class="row"><label>Password</label><input id="suPass" type="password"></div>
      <div class="row"><label>Confirm</label><input id="suPass2" type="password"></div>
      <button class="btn btn-primary" id="btnSignupGo">Create account</button>
    </div>
    <div id="authMsg" class="note" style="margin-top:.5rem"></div>
  </div>
</div>

<!-- CONFIG -->
<script>
window.CONFIG_PUBLIC={
  DATABASE:{
    SUPABASE_URL:"https://oujvsjnbxmgpdoftzpxl.supabase.co",
    SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im91anZzam5ieG1ncGRvZnR6cHhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NzE1NTYsImV4cCI6MjA3ODQ0NzU1Nn0.vs06C-2kx4H2whyTReUPsVgLYhWotfkzetxdKD5LVQo"
  },
  ADMIN:{OWNER_UID:"2ece6eb8-ed7d-4e52-b1b8-f9220fb87e36"}
};
</script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/js/aiaxcart/supabase.js?v=6"></script>
<script>
function toast(msg,type='ok'){
  const box=document.getElementById('toast');
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  box.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),300); },1800);
}

const SB = createDbClient();

/* ===== auth local + buyer table ===== */
let currentUser = getSavedUser();

function getSavedUser(){
  const s=localStorage.getItem('aiaxcart_current_user');
  return s?JSON.parse(s):null;
}
function saveUser(u){
  currentUser=u;
  if(u) localStorage.setItem('aiaxcart_current_user',JSON.stringify(u));
  else localStorage.removeItem('aiaxcart_current_user');
}

/* DOM refs */
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const authButtons=document.getElementById('authButtons');
const userInfo=document.getElementById('userInfo');
const userAvatar=document.getElementById('userAvatar');
const userName=document.getElementById('userName');

const authOverlay=document.getElementById('authOverlay');
const authMsg=document.getElementById('authMsg');
const tabLogin=document.getElementById('tabLogin');
const tabSignup=document.getElementById('tabSignup');
const formLogin=document.getElementById('formLogin');
const formSignup=document.getElementById('formSignup');
const authCloseBtn=document.getElementById('authCloseBtn');

const liEmail=document.getElementById('liEmail');
const liPass=document.getElementById('liPass');
const suName=document.getElementById('suName');
const suEmail=document.getElementById('suEmail');
const suPass=document.getElementById('suPass');
const suPass2=document.getElementById('suPass2');
const btnSignupGo=document.getElementById('btnSignupGo');
const btnLoginGo=document.getElementById('btnLoginGo');

const productSearch=document.getElementById('productSearch');
const productsWrap=document.getElementById('productsWrap');
const productsSection=document.getElementById('productsSection');

const accountsContent=document.getElementById('accountsContent');
const reportsContent=document.getElementById('reportsContent');
const paymentsContent=document.getElementById('paymentsContent');
const rulesContent=document.getElementById('rulesContent');
const feedbackContent=document.getElementById('feedbackContent');
const aboutContent=document.getElementById('aboutContent');

const coOverlay=document.getElementById('coOverlay');
const coForm=document.getElementById('coForm');
const coTitle=document.getElementById('coTitle');
const coAccType=document.getElementById('coAccType');
const inviteGmailRow=document.getElementById('inviteGmailRow');
const coMsg=document.getElementById('coMsg');
const coSubmit=document.getElementById('coSubmit');
const coCancel=document.getElementById('coCancel');

const reportGate=document.getElementById('reportGate');
const reportForm=document.getElementById('reportForm');
const repOrder=document.getElementById('repOrder');
const repProduct=document.getElementById('repProduct');
const repIssue=document.getElementById('repIssue');
const repImg=document.getElementById('repImg');
const repSubmit=document.getElementById('repSubmit');
const myReports=document.getElementById('myReports');

const rulesSearch=document.getElementById('rulesSearch');
const rulesWrap=document.getElementById('rulesWrap');

const fbGate=document.getElementById('fbGate');
const fbForm=document.getElementById('fbForm');
const fbText=document.getElementById('fbText');
const fbImg=document.getElementById('fbImg');
const fbSubmit=document.getElementById('fbSubmit');
const fbList=document.getElementById('fbList');

/* Auth modal helpers */
function openAuth(){ authOverlay.style.display='flex'; }
function closeAuth(){ authOverlay.style.display='none'; authMsg.textContent=''; }

loginBtn.onclick=openAuth;
authCloseBtn.onclick=closeAuth;

logoutBtn.onclick=()=>{
  saveUser(null);
  refreshAuthUI();
  toast('Logged out','ok');
};

function refreshAuthUI(){
  if(currentUser){
    authButtons.style.display='none';
    userInfo.style.display='flex';
    userName.textContent=currentUser.name;
    userAvatar.textContent=currentUser.name.charAt(0).toUpperCase();
  }else{
    authButtons.style.display='block';
    userInfo.style.display='none';
  }
  gateReportUI();
  gateFeedbackUI();
}

tabLogin.onclick=()=>{
  formLogin.style.display='block';
  formSignup.style.display='none';
};
tabSignup.onclick=()=>{
  formLogin.style.display='none';
  formSignup.style.display='block';
};

/* signup / login */
btnSignupGo.onclick=async()=>{
  const n=suName.value.trim();
  const e=suEmail.value.trim();
  const p=suPass.value;
  const p2=suPass2.value;
  if(!n||!e||!p||p!==p2){ authMsg.textContent='Check inputs.'; return; }
  let arr=JSON.parse(localStorage.getItem('aiaxcart_users')||'[]');
  if(arr.some(x=>x.email===e)){ authMsg.textContent='Email exists.'; return; }
  const u={id:Date.now(),name:n,email:e,password:p,joinDate:new Date().toISOString()};
  arr.push(u);
  localStorage.setItem('aiaxcart_users',JSON.stringify(arr));
  await db_upsertBuyer(u);
  saveUser(u);
  refreshAuthUI();
  closeAuth();
  toast('Account created','ok');
};

btnLoginGo.onclick=async()=>{
  const e=liEmail.value.trim();
  const p=liPass.value;
  const arr=JSON.parse(localStorage.getItem('aiaxcart_users')||'[]');
  const u=arr.find(x=>x.email===e && x.password===p);
  if(!u){ authMsg.textContent='Invalid credentials.'; return; }
  await db_upsertBuyer(u);
  saveUser(u);
  refreshAuthUI();
  closeAuth();
  toast('Welcome back','ok');
};

/* Tabs behaviour */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');

    // hide all sections
    [productsSection,accountsContent,reportsContent,paymentsContent,rulesContent,feedbackContent,aboutContent]
      .forEach(sec=>sec.style.display='none');

    const key=tab.dataset.tab;
    if(key==='products'){
      productsSection.style.display='block';
    }else if(key==='accounts'){
      accountsContent.style.display='block';
      if(currentUser) updateAccountTab();
    }else if(key==='reports'){
      reportsContent.style.display='block';
      if(currentUser) loadUserReports();
    }else if(key==='payments'){
      paymentsContent.style.display='block';
    }else if(key==='rules'){
      rulesContent.style.display='block';
      loadRules();
    }else if(key==='feedback'){
      feedbackContent.style.display='block';
      loadFeedback();
    }else if(key==='about'){
      aboutContent.style.display='block';
    }
  });
});

/* Search on products */
productSearch.addEventListener('input',(e)=>{
  const q=e.target.value.toLowerCase();
  document.querySelectorAll('#productsWrap .p-card').forEach(card=>{
    card.style.display = (card.dataset.name||'').includes(q) ? '' : 'none';
  });
});

/* Products rendering */
async function renderProducts(){
  productsWrap.textContent='Loading‚Ä¶';
  if(window.AIAX_CATALOG){
    try{ await db_seedCatalogIfEmpty(window.AIAX_CATALOG); }catch(_){}
  }
  try{
    const rows=await db_listCatalogWithCounts();
    productsWrap.innerHTML = rows.map(p=>{
      const hasStock=(p.available||0)>0;
      const pricesByType={};
      (p.prices||[]).forEach(x=>{
        (pricesByType[x.account_type]=pricesByType[x.account_type]||[])
          .push(`${x.duration_key}: ‚Ç±${x.price_php}`);
      });
      const pricesHtml = Object.entries(pricesByType).map(([t,arr])=>`
        <div class="note"><b>${t}</b> ‚Äî ${arr.join(' ¬∑ ')}</div>`).join('');
      return `
      <div class="p-card" data-name="${(p.name||'').toLowerCase()}">
        <div style="font-weight:700">${p.icon||'üõí'} ${p.name}</div>
        <div class="note">${p.category}</div>
        <div style="margin:.4rem 0">
          ${hasStock
            ? `<span class="pill" style="background:#d4edda;color:#155724">${p.available} available</span>`
            : `<span class="pill">Out of stock</span>`}
          ${p.archived?` <span class="pill">${p.archived} archived</span>`:''}
        </div>
        ${pricesHtml}
        <button class="btn btn-primary" ${hasStock?'':'disabled'} onclick="openCheckout('${p.id}','${p.name}')">
          ${hasStock?'Buy':'Unavailable'}
        </button>
      </div>`;
    }).join('') || '<div class="note">No products yet.</div>';
  }catch(e){
    console.error(e);
    productsWrap.innerHTML='<div class="note">Failed to load products.</div>';
  }
}

function openCheckout(product_id,product_name){
  const f=coForm;
  f.product_id.value=product_id;
  f.product_name.value=product_name;
  coTitle.textContent='Checkout ‚Ä¢ '+product_name;
  if(currentUser){
    f.buyer_name.value=currentUser.name;
    f.buyer_email.value=currentUser.email;
  }else{
    f.buyer_name.value='';
    f.buyer_email.value='';
  }
  inviteGmailRow.style.display = (coAccType.value.toLowerCase()==='invite')?'block':'none';
  coMsg.textContent='';
  coOverlay.style.display='flex';
}
function closeCheckout(){ coOverlay.style.display='none'; }
coCancel.onclick=closeCheckout;

coAccType.onchange=(e)=>{
  inviteGmailRow.style.display = (e.target.value.toLowerCase()==='invite')?'block':'none';
};

coForm.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const f=e.target;
  coSubmit.disabled=true;
  try{
    if(f.account_type.value.toLowerCase()==='invite'){
      const gm=(f.invite_gmail.value||'').trim();
      if(!/^[^@]+@gmail\.com$/i.test(gm)) throw new Error('Invite requires a valid Gmail.');
    }
    const order=await db_createOrder({
      buyer_name:f.buyer_name.value.trim(),
      buyer_email:f.buyer_email.value.trim(),
      product_id:f.product_id.value,
      product_name:f.product_name.value,
      account_type:f.account_type.value,
      duration_key:f.duration_key.value,
      price:parseFloat(f.price.value||0),
      invite_gmail:f.invite_gmail?f.invite_gmail.value.trim():null
    });
    coMsg.textContent='‚úÖ Order placed! ID: '+o
